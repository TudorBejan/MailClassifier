YUI.add("mail-controller-messages-ops",function(F){var K,d,j=F.mail,Q=j.model.DataStore,i=Q.Messages,a=F.common.Utils,C=j.Controller,I=C.Folders,X=F.Lang,f={passthru:{move:"MoveMessages",flag:"FlagMessages",remove:"DeleteMessages",fullHeader:"GetMessageRawHeader",redirectMsg:"RedirectMessage",addFilter:"AddFilters"},isdup:{FlagMessages:function(m,l){var k=m.setFlags,Y=l.setFlags;if(m.mid&&l.mid&&m.mid.length==1&&l.mid.length==1&&m.mid[0]==l.mid[0]&&k.read==Y.read&&k.flagged==Y.flagged){return true;}}}},N,W,E="%40C%40Chats",g="Trash",J="%40B%40Bulk",c={"replied":"isReplied","flagged":"isFlagged","read":"isRead","draft":"isDraft","forwarded":"isForwarded","ham":"isHam","spam":"isSpam"},M=strings.str_cfg_tog_set_spam_read_flag,Z={};f.batchable=f.passthru;N=C.extend("Messages",f);W=N.Error;d=f.order;function e(m,s,l){var k,n,q=s.parms,Y=s.reason,o=s.api,p=m.error,t;if(NeoConfig.scanMoveAction==true&&s.method==="MoveMessages"){for(var n=0;n<q.mid.length;n++){t=q.mid[n]&&U(q.mid[n]);if(t&&Z[t]){delete Z[t];}}}if(p){for(n=0;n<p.length;n++){if(p[n].code=="-1400"){a.rocketstats.stat("msgops","TAE4:-1400:"+s.method);}if(p[n].code=="WARN"){a.rocketstats.stat("msgops","TAE4:CODE:WARN:"+s.method);}}for(n=0;n<p.length;n++){if(p[n].code!="WARN"){l("failure");return N._error(m,W.invalidmid);}}}if(o=="move"){i.move(q.sourceFid,q.destinationFid,q.mid,m.mid,Y);}if((k=m.sourceFolder)&&s.custom.isSparse){Q.Folders.set(k,"ds:msg:",1);}if(k=m.destinationFolder){Q.Folders.set(k,"ds:msg:",1);}}function P(m,r){var o,n=m.destinationFid&&m.destinationFid==J,k,p=r.origParms,Y=p.destinationFid,l=p.sourceFid,q=r.origParms.mid;if(n){k={};if(Y==J){k[c["spam"]]=1;k[c["ham"]]=0;}if(l==J&&Y!=g){k[c["ham"]]=1;k[c["spam"]]=0;}i.update(m.sourceFid||m.fid,q,{flags:k},"flag");if(M){for(o=0;o<q.length;o++){q[o].flags.isRead=1;}}}i.remove(m.sourceFid||m.fid,q,!m.destinationFid,m.destinationFid);}function R(m,o,n){var l=o.origParms,k,Y=m.returnCodes;if(Y&&Y.length){for(k=0;k<Y.length;k++){if(Y[k].code!="WARN"){n("failure");return N._error(m,W.invalidmid);}}}else{if(!l.mid){I.refresh();}else{if(o.custom.isSparse&&T(l.setFlags,"read")){if(!o.noRefresh){I.refresh();}}}}}function T(k,Y){return k&&(Y in k);}function L(n,k){var m,Y,l=n.setFlags;Y={};for(m in l){Y[c[m]]=l[m];}if(Y[c["spam"]]){Y[c["ham"]]=0;}if(Y[c["ham"]]){Y[c["spam"]]=0;}if(X.isUndefined(l.spam)&&k.reason!=="move"){i.update(n.fid,k.origParms.mid||[],{flags:Y},k.reason);}}function S(l,Y){var n,k=0,m=Y.origParms.mid;while(n=m[k++]){if(!n.header){Y.custom.isSparse=1;}}}function V(Y,k){k("failure");a.rocketstats.stat("msgops","invalidparm_"+Y.api);return N._error({},W.invalidparams);}function O(k,m){var Y=0,l=k.mid;if(m){k.mid=X.isArray(l)?l[0].mid:l.mid;return 1;}if(!X.isArray(l)){l=(l?[l]:[]);}k.mid=[];for(;Y<l.length;Y++){k.mid[Y]=l[Y].mid||l[Y];}return Y||k.selection;}function H(n,s,AC){var AB=n.mid,v,u,q,l={},t,w,r,p,k,x,o,AA=[],y=10,z=n.sourceFid,Y=z||n.fid;n.enableRetry=true;for(u=0,v=AB.length;u<v;u++){w=AB[u].fid||Y;if(!l[w]){l[w]=[];}l[w].push(AB[u]);}if((p=a.size(l))==1&&w=="%40S%40Search"){return;}if(s.api=="remove"){if(Y=="%40S%40Search"){n.sourceFid=n.sourceFid||n.fid;delete n.fid;n.destinationFid=g;s.newApi("move","MoveMessages",n);AC("pre","move");AC(1,n);}return;}delete n.mids;for(u in l){o=F.clone(n);if(z){o.sourceFid=u;}else{o.fid=u;}o.mid=l[u];AA[AA.length]=o;}a.assert(p==AA.length);if(p>1){var m=AC(function(){s.cbk.abort();});x=Math.ceil(p/y);for(q=0;q<x;q++){r=C.batch().Messages;for(u=q*y;(u<p&&u<q*y+y);u++){if(u==p-1){r[s.api](AA[u],{success:function(AD){m(AD,"success",d.usercbk);},failure:function(AD){m(AD,"failure",d.usercbk);}});}else{r[s.api](AA[u]);}}r.execute();}}else{return AA[0];}}function h(l,Y,o){var n=l.mid,k=n.mid||n,m=l.fid;if(m=="%40S%40Search"){l.enableRetry=true;if(n.fid&&(n.fid!=m)){l.fid=n.fid;}O(l,Y.api==="fullHeader");}}function b(t,w,n){var l,Y,k,u,x,p,m=0,o=t.mid,q=t.setFlags,v=t.mid=[];if(a.isEmpty(q)){return V(w,n);}if(!X.isArray(o)){o=(o)?[o]:[];}if((q.spam&&(t.fid!=J))||(q.ham&&(t.fid==J))||(q.sendercompromised&&(t.fid!=J))||(q.phished&&(t.fid!=J))){k=1;}while(l=o[m++]){if(!a.isEmpty(l.flags)){l=i.get(t.fid,l.mid)||l;for(Y in q){if((l.flags[c[Y]]!=q[Y])||k){v.push(l);break;}}}else{v.push(l);w.custom.isSparse=1;}}if(o.length&&!v.length){n("success");return;}if(!O(t)){return V(w,n);}if(!t.spam&&((u=q.spam)||(x=q.sendercompromised)||(p=q.phished)||q.ham)){var r=w.getBatch(),s={sourceFid:t.fid,destinationFid:(u||x||p)?J:"Inbox",mid:o||w.origParms.mid,spam:1,enableRetry:t.enableRetry||false};w.noRefresh=1;if((u||x||p)&&M){q.read=1;}n(1,t);r.Messages.move(s);r.execute(w.cbk);}delete t.spam;}function A(p,q,k){var o,l,n=p.destinationFid,r=p.sourceFid,m={fid:r,mid:p.mid,spam:1,enableRetry:p.enableRetry||false},Y=function(){var u,s=p.mid.length;if(s>100){return;}for(var t=0;t<s;t++){u=p.mid[t]&&p.mid[t].mid&&U(p.mid[t].mid);if(u&&Z[u]){k("failure");}else{Z[u]=true;}}};if(!p.spam){if(n==J){l=m.setFlags={spam:1};if(M){l.read=1;}}if(r==J&&n!=g){l=m.setFlags={ham:1};}}!l&&NeoConfig.scanMoveAction&&Y();if(l){q.newApi("flag","FlagMessages",m);o=q.getBatch();q.noRefresh=1;k("pre","flag");k(1,m);p.spam=1;p.bidiDetection=NeoConfig.bidi;o.Messages.move(p);o.execute(q.cbk);}delete p.spam;if(!O(p)){return V(q,k);}}function U(Y){var k=Y.split("_");return k[k.length-1];}function D(k,Y,l){if((k.fid!=g)&&(k.fid!=J)&&(k.fid!=E)&&!k.force){k.sourceFid=k.fid;delete k.fid;k.destinationFid=g;Y.api=Y.reason="move";Y.method=f.passthru["move"];l("pre","move");return k;}delete k.force;if(!O(k)){return V(Y,l);}}function B(k,Y){var l=Y.parms.mid;if(NeoConfig.scanMoveAction==true&&Y.method=="MoveMessages"&&k.fault=="aborted"){Z=[];}if(k&&(k.reason==W.invalidparams)){return;}if(Y.parms.sourceFid){i.flush(0,1);}I.refresh();}function G(l,Y){if(l&&(l.reason==W.invalidparams)){return;}var k=Y.parms;if("read" in k.setFlags){I.refresh();}else{i.flush(k.fid);}}K={success:e,failure:B};N.hook({move:K,remove:K,flag:{success:R,failure:G}});K={pre:P};N.hook({move:K,remove:K},0,d.optimistic);
N.hook({move:{pre:H},remove:{pre:H},flag:{pre:H},fullHeader:{pre:h},redirectMsg:{pre:H}},0,d.fixParms);N.hook({move:{pre:A,aborted:B},remove:{pre:D,aborted:B},flag:{pre:b,aborted:G},redirectMsg:{pre:function(Y){O(Y);}}},0,d.fixParms);N.hook({move:{pre:S},flag:{pre:L}},0,d.optimistic);F.mix(W,{invalidmid:W._reservedIdx+1,invalidparams:W._reservedIdx+1,noitems:W._reservedIdx+2});},"3.0.0",{requires:["rocket-stats","mail-controller-base","mail-model-datastore","json-stringify"]});