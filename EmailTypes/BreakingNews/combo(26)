YUI.add("common-ui-lozengeDD",function(B){B.namespace("common.ui");var H=B.common.Utils;var F=function(J){var K=this;K.inputUl=null;K.insertBefore=null;K.dummyElement=null;K.targetNode=null;K.selectMultipleLozenges=false;K.composeView=J.composeView,K.composeHeader=J.composeView.baseNode.one(".compose-header");K.firstMove=true;K.allInputBoxes=K.composeHeader.all("div div.ac-input");K.clonedLozenge=null;K.wasHighlighted=false;K.dd=new B.mail.DD({start:K.start,end:K.end,move:K.move,scope:K,node:K.composeHeader,dragSelector:J.dragSelector});H.setSelect(this.composeHeader,false);};var A=function(K){this.init(K);var J=this.getTargetNode(K);if(J){K.dd.proxy.setXY([-100,-100]);this.dummyElement.setStyle("opacity",0);}};var D=function(N){var O=this,M=O.getTargetNode(N),K=N.dd.proxy,J;var L=function(R,P){var Q=O.insertBefore;if(K.inRegion(P)){O.inputUl=P.one("ul");O.allInputBoxes.removeClass("focus");P.addClass("focus");Q=null;J=O.inputUl.all("li");J.each(function(S){if(O.clonedLozenge.inRegion(S)){if(!Q){Q=S;}}});if(!Q){Q=J.item(J.size()-1);}Q.insert(O.dummyElement,Q);}else{if(P.hasClass("focus")){P.removeClass("focus");O.inputUl=null;}}O.insertBefore=Q;};if(K){if(O.firstMove){O.firstMove=false;M.setStyle("display","none");O.composeHeader.all(".hLozenge").each(function(P){P.removeClass("focus");});}K.setStyle("top",N.pageY);K.setStyle("left",N.pageX);K.setXY([N.pageX,N.pageY]);if(K.inRegion(O.composeHeader)){O.allInputBoxes.each(function(P){L(N,P);});}}};var E=function(L){var M=this,K=this.getTargetNode(L),J=M.insertBefore;if(K){L.dd.proxy.remove().destroy(true);if(M.inputUl&&J){K.remove();M.inputUl.get("parentNode").removeClass("focus");if(!this.selectMultipleLozenges){J.insert(K,J);}else{K.each(function(N){J.insert(N,J);N.removeClass("focus");});}M.composeView.dirty=true;}else{if(this.wasHighlighted){K.addClass("focus");}}M.dummyElement.remove().destroy(true);M.dummyElement=null;K.setStyle("display","inline-block");K.removeAttribute("style");L.dd.proxy=null;M.targetNode=null;M.selectedLozenges=false;M.firstMove=true;M.insertBefore=null;L.notDragging=false;M.wasHighlighted=false;M.selectMultipleLozenges=false;}};var C=function(J){return this.targetNode||null;};var I=function(P){var O=this,R,K=0,J,Q=P.dd.proxy,N;var M=function(){L(P);if(O.targetNode){var S=O.targetNode.cloneNode(true);S.replaceClass("hLozenge","dd-hLozengeBox");S.one("input").remove();P.dd.proxy=B.Node.create('<div style="position:absolute"></div>');P.dd.proxy.appendChild(S);O.clonedLozenge=S;O.dummyElement=O.targetNode.cloneNode(true);}};var L=function(T){var U,S=T.target;U=(B.Node.getDOMNode(S)).nodeName;if(U=="LI"&&S.hasClass("hLozenge")){O.targetNode=S;}else{O.targetNode=S.ancestor("li.hLozenge");}return O.targetNode;};R=P.target.ancestor("ul");if(!R){O.targetNode=null;}else{if(P.target.hasClass("lozenge-edit")){O.targetNode=null;P.notDragging=true;}else{if(R.one("li.focus")){N=L(P);O.targetNode=R.all("li.focus");K=O.targetNode.size();if(K==1||!N.hasClass("focus")){if(N.hasClass("focus")){O.wasHighlighted=true;}M();}else{O.wasHighlighted=true;P.dd.proxy=B.Node.create('<div style="z-index: 999" class="contactDragProxy"><span></span><b class="counter">'+K+"</b></div>");O.clonedLozenge=P.dd.proxy;if(!O.dummyElement){O.dummyElement=O.targetNode.item(0).cloneNode(true);}O.selectMultipleLozenges=true;}}else{M();}}}if(P.dd.proxy){B.one("body").append(P.dd.proxy);}};var G=function(){this.dd.destroy();};F.prototype={destroy:G,start:A,end:E,move:D,getTargetNode:C,init:I};B.common.ui.lozengeDD=F;},"1.0.0",{requires:["common-ui-dd","common-utils"]});