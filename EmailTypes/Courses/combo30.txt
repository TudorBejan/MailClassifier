YUI.add("mail-ui-mailpane-next-prev",function(E){E.namespace("mail.ui");var B=E.mail,A=B.ui,C=E.common;var D=function(F){var G=this;};E.mix(D.prototype,{stepMessage:function(I,H,F,G){},dialogThenStep:function(H,I,F,G){}});E.mail.ui.MailPaneNextPrev=D;},"1.0.0",{requires:["mail-ui-common-string-utils","common-utils","common-utils-stats"]});YUI.add("mail-ui-messagepane-next-prev",function(E){E.namespace("mail.ui");var P=E.mail,I=P.ui,B=P.model.DataStore.Messages,Q=P.Controller.Messages,L=E.common,H=I._MessagePane,G=I.MessageList?I.MessageList.prototype.columns:{},K=E.common.Utils;var D=function(){var R=this;D.superclass.constructor.call(R,null);};function O(U,T,R,S,V){var W=this;if(W.stepTimer){W.stepTimer.cancel();}if(U=="next"){W.nextPrevCounter++;}else{W.nextPrevCounter--;}W.stepTimer=E.Lang.later(200,W,W.findNextMessage,[T,0,R,S,V]);}function C(k,c,a,R,S){var j=this,o,b,h=j.fid,m=j.stepIndex,g=j.arrMessageSequence,X,Z=g&&g.length||0,l,U,V=0,k=k||0,T;j.stepTimer=0;if(j.nextPrevCounter==0||j.isStepping){return;}j.isStepping=1;b=j.nextPrevCounter;o=b>0?"next":"prev";j.nextPrevCounter=0;try{U=m+b;if(typeof m!="undefined"&&m!=null&&g&&g[U]){V=g[U];j.stepIndex=U;if(a&&!c){j.arrMessageSequence.splice(m,1);j.stepIndex=(U>0)?U--:U;}}else{for(l=0;l<Z;l++){if((X=g[l])&&((X.mid==j.message.mid)||(B.isSearchMid(X.mid)&&B.getPermMidPart(X.mid)==B.getPermMidPart(j.message.mid)))){U=l+b;if(U<Z&&U>=0){V=g[U];j.stepIndex=U;}if(a&&!c){j.arrMessageSequence.splice(l,1);if(U==-1){U=0;V=g[U];}j.stepIndex=(U>0)?U--:U;}break;}}}if(j.searchQuery&&V){j.searchItemIndex=(o=="prev")?j.searchItemIndex-1:j.searchItemIndex+1;}if(!V){if(j.searchQuery&&h!="%40S%40Search"){if(k){k(V);}else{if(j.searchQuery){var f=function(e){if(j.isList){e.hits=e.messageInfo;e.count=e.numInfo;e.total=e.folder.total;e.start=e.startInfo;}j.searchListMgr.store((j.isList)?j.processData(e,j.fid):e.response);j.arrMessageSequence=j.searchListMgr.getAllCachedItems();j.searchItemIndex=(o=="prev")?j.searchItemIndex-1:j.searchItemIndex+1;V=j.arrMessageSequence[j.searchItemIndex];if(V){j.updateMessageInTab(V.fid,V,(o=="prev"?-1:1));}j.isStepping=0;};var d=j.searchListMgr.getCacheInfo()["serverTotal"],W=j.searchRequestAttrs,Y;W.start=(W.start)?W.start:W.startInfo;Y=((W.start+50)<d)?W.start+50:W.start;j.isList=j.type=="list";j.searchItemIndex=j.searchListMgr.getItemIndex(j.message.mid);if((j.searchItemIndex==0)||(j.searchItemIndex==d-1)){j.displayError(o,"%40S%40Search");j.isStepping=0;}else{j.searchRequestAttrs.start=Y;if(!j.isList){var p=new E.mail.ui.SearchRequest(j.searchRequestAttrs);p.execute(f,j);}else{W.startInfo=Y;E.mail.Controller.Messages.list(W,f);}}}else{j.displayError(o,"%40S%40Search");j.isStepping=0;}}}else{j.updateSequenceArray(b,U,o,k,c,a,S);}}else{if(V&&V.mid!=j.message.mid){if(!c){T=j.updateMessageInTab(V.fid||h,V,(o=="prev"?-1:1),R);}if(k&&(T||!S)){k(V);}if(!c){j.isStepping=0;}}else{j.isStepping=0;}}}catch(n){j.isStepping=0;}}function F(W,T,V,U){if(!T||!W){return;}var Y=this,X,R=new L.Utils.Stopwatch("MsgInTab");R.mid=T.mid;Y.stopwatch=R;var S=E.mail.Tabs.getTab(function(Z){return Z.msgPane&&Z.msgPane.fullView&&(T.mid==Z.msgPane.get("message").message.mid);});if(S){S.set("active",1,{noScroll:false});Y.set("close",1,{noScroll:false});return false;}if(Y.fullView&&NeoConfig.fullPage){if(U){X=E.config.win||window;X.scrollTo(0,0);}}Y.set("message",{message:B.toMessage(W,T),fid:W});Y.fire("preloadDarla",{msg:T});Y.once("renderComplete",function(Z){if(Z.currentTarget.message.mid==R.mid){R.stop();delete Y.stopwatch;}E.Lang.later(0,Y,Y.preCacheLinear,V);});if(T&&(E.mail.ui.Workspace.prefetchedMidsHash[T.mid]==="server")){K.rocketstats.stat("workspace","readServerPrefetchedMessage");}return true;}function N(U){if(U!=1&&U!=-1){return;}var V=this,S=V.arrMessageSequence,R=[],T;if(!E.mail.common.cachewarmer||!S){return;}if((T=S[V.stepIndex+U])&&!B.isCached(V.fid,T.mid)){R.push({mid:T.mid});}if(V.fid!="%40B%40Bulk"&&V.fid!="Trash"){R.length&&E.fire("startPrefetch",{fid:V.fid,msgHdrList:0,delay:100,preCacheMids:R});}R=null;}function A(W,e,d,S,a,R,V){var X=this,U=X.sortedColumn||G.date,T=X.fid,Z=X.searchQuery||"",c=W>0?W*100+1:W*-100+1,Y={sortKey:U.sortKey,sortOrder:U.sortOrder,groupBy:U.groupBy},b={success:function(j){try{if(X.get("close")){X.isStepping=0;return;}var q=j.messageInfo,n=q.length,f=j.folder.folderInfo,h=f.fid,l,p,m,k=0,g=0;X.arrMessageSequence=q;for(l=0;l<n;l++){if((p=q[l])&&(p.mid==X.message.mid)){m=l+W;if(m<n&&m>=0){k=q[m];X.stepIndex=m;}else{g=1;}if(R&&!a){X.arrMessageSequence.splice(l,1);X.stepIndex=(e>0)?e--:e;}break;}}if(g&&(!S||V)){X.displayError(d,h);}else{if(g&&S&&d=="prev"){X.arrMessageSequence=0;X.stepIndex=null;if(a){X.isStepping=0;}else{X.set("close",1);}S(k);}else{if(g&&S){X.stepIndex=null;X.arrMessageSequence=0;X.isStepping=0;X.nextPrevCounter=W*-1;X.findNextMessage(S,a,R);}else{if(k&&k.mid!=X.message.mid){if(!a){X.updateMessageInTab(h,k,(d=="prev"?-1:1));}if(S){S(k);}}}}}if(!a){X.isStepping=0;}}catch(o){}},failure:function(){}};if(T=="%40S%40Search"){L.Utils.merge(Y,{search:{query:Z},numInfo:600});Q.search(Y,b);}else{setTimeout(function(){Q.list(L.Utils.merge(Y,{loc:"centerOn",fid:T,numInfo:c,offsetMid:X.message.mid}),b);},0);}}function J(R,S){E.use("common-ui-dialog-helper",function(W){var V=(R=="next")?strings.str_error_last_message:strings.str_error_first_message,T=R=="next"?strings.str_modal_last_msg_title:strings.str_modal_first_msg_title,U=P.model.DataStore.Folders.get(S);if(!U){U={fid:S};}else{U=U.folderInfo;}L.ui.DialogHelper.alert({hd:T,bd:L.Utils.substitute(V,{folder_name:I.common.StringUtils.getSystemFolderName(U.fid,U.name)})});});}function M(U,V,S,T){var W=this,R;S.afterHandle=function(X){if(X&&X.targetMsg){W.updateMessageInTab(W.fid,X.targetMsg,1);}W.isStepping=0;W.stepIndex=null;W.arrMessageSequence=null;};S.cancelCbk=function(){W.isStepping=0;W.stepIndex=null;};R=function(X){S.afterHandleParams={targetMsg:X};U.handleUI(S,W.fid,null,[V?V.message:null]);};W.nextPrevCounter++;W.findNextMessage(R,1,T);}E.extend(D,I.MailPaneNextPrev,{stepMessage:O,findNextMessage:C,updateSequenceArray:A,updateMessageInTab:F,dialogThenStep:M,preCacheLinear:N,displayError:J});E.mix(H.prototype,D.prototype);},"1.0.0",{requires:["mail-ui-common-string-utils","mail-ui-messagepane-base","mail-ui-mailpane-next-prev","mail-model-datastore","mail-controller-messages","common-utils","common-utils-stats"]});
