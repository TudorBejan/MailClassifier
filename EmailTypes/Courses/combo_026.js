var JSON;if(!JSON){JSON={}}(function(){function f(n){return n<10?"0"+n:n}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(key){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf()}}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==="object"&&typeof value.toJSON==="function"){value=value.toJSON(key)}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==="[object Array]"){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){if(typeof rep[i]==="string"){k=rep[i];v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}}if(typeof JSON.stringify!=="function"){JSON.stringify=function(value,replacer,space){var i;gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else{if(typeof space==="string"){indent=space}}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("JSON.stringify")}return str("",{"":value})}}if(typeof JSON.parse!=="function"){JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}}}());var YUI;if(typeof YUI==="undefined"){(function(){var e=".",b=Object.prototype.hasOwnProperty,d=Object.prototype.toString,c={"undefined":"undefined",number:"number","boolean":"boolean",string:"string","[object Function]":"function","[object RegExp]":"regexp","[object Array]":"array","[object Date]":"date","[object Error]":"error"},f,a=function(j,i){var h=typeof j;return(j&&(h==="object"||(!i&&(h==="function"||f.Lang.isFunction(j)))))||false};f={namespace:function(){var k=arguments,q=this,n=0,m,p,h;for(;n<k.length;n++){h=k[n];if(h.indexOf(e)){p=h.split(e);for(m=(p[0]=="YAHOO")?1:0;m<p.length;m++){q[p[m]]=q[p[m]]||{};q=q[p[m]]}}else{q[h]=q[h]||{}}}return q},add:function(h,i){if(i){i(f)}},use:function(){var h=arguments[arguments.length-1];if(typeof h==="function"){h(f)}},log:function(){},merge:function(){var k=arguments,m=0,j=k.length,h={};for(;m<j;++m){f.mix(h,k[m],true)}return h},Object:{_hasEnumBug:!{valueOf:0}.propertyIsEnumerable("valueOf"),_forceEnum:["hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toString","toLocaleString","valueOf"]},mix:function(h,j,q,k,n,r){var o,u,t,m,v,p,s;if(!h||!j){return h||f}if(n){if(n===2){f.mix(h.prototype,j.prototype,q,k,0,r)}t=n===1||n===3?j.prototype:j;s=n===1||n===4?h.prototype:h;if(!t||!s){return h}}else{t=j;s=h}o=q&&!r;if(k){for(m=0,p=k.length;m<p;++m){v=k[m];if(!b.call(t,v)){continue}u=o?false:b.call(s,v);if(r&&u&&a(s[v],true)&&a(t[v],true)){f.mix(s[v],t[v],q,null,0,r)}else{if(q||!u){s[v]=t[v]}}}}else{for(v in t){if(!b.call(t,v)){continue}u=o?false:b.call(s,v);if(r&&u&&a(s[v],true)&&a(t[v],true)){f.mix(s[v],t[v],q,null,0,r)}else{if(q||!u){s[v]=t[v]}}}if(f.Object._hasEnumBug){f.mix(s,t,q,f.Object._forceEnum,n,r)}}return h},Lang:{isString:function(h){return typeof h==="string"},isFunction:function(h){return f.Lang.type(h)==="function"},type:function(h){return c[typeof h]||c[d.call(h)]||(h?"object":"null")}}};YUI=function(){return f};for(var g in f){if(f.hasOwnProperty(g)){YUI[g]=f[g]}}})()}if(typeof YAHOO==="undefined"||!YAHOO){var YAHOO={util:{}}}if(typeof YAHOO.util==="undefined"||!YAHOO.util){YAHOO.util={}}if(!YAHOO.util.CrossFrame){YAHOO.util.CrossFrame=(function(){var k=/^frames\[(\d+)\]$/,h=/^frames\[['"]([a-zA-Z0-9-_]+)['"]\]$/;var m,e,g,o,i,f,c,b,n,a=YUI;if(window.postMessage||document.postMessage){c=function(p,s,q){var r;if(n(q||"1.0.15","1.0.15")<1){r=[i(s),i(p)].join("|")}else{r=[i(q),i(s),i(p)].join("|")}return r};b=function(r){var q=r.split("|"),p;for(p=q.length-1;p>=0;--p){q[p]=f(q[p])}if(q.length==2){return{sig:q[0],body:q[1]}}else{if(q.length==3){return{version:q[0],sig:q[1],body:q[2]}}else{return null}}};i=function(p){return p.replace(/\|/g,"&c124;")};f=function(p){return p.replace(/&c124;/g,"|")}}else{c=function(p,u,q,s,r){var t;q=q||"1.0.15";if(n(q,"1.0.15")<1){t=[u,p.replace(/\&/g,"&c38;").replace(/\"/g,"&c34;").replace(/\'/g,"&c39;").replace(/\\/g,"&c92;").replace(/\0/g,"&c0;").replace(/\n/g,"&c10;").replace(/\r/g,"&c13;")].join("|")}else{if(n(q,"1.1.9")<0){t=[i(q),i(u),i(p)].join("|")}else{t=[i(q),i(u),i(p),i(s),i(r)].join("|")}}return t};b=function(q){var p=q.split("|");if(p.length===2){return{sig:p[0],body:p[1].replace(/&c13;/g,"\r").replace(/&c10;/g,"\n").replace(/&c0;/g,"\0").replace(/&c92;/g,"\\").replace(/&c39;/g,"'").replace(/&c34;/g,'"').replace(/&c38;/g,"&")}}else{if(p.length===3){return{version:f(p[0]),sig:f(p[1]),body:f(p[2])}}else{if(p.length===5){return{version:f(p[0]),sig:f(p[1]),body:f(p[2]),target:f(p[3]),url:f(p[4])}}else{return null}}}};i=function(p){return escape(p.replace(/\&/g,"&c38;").replace(/\"/g,"&c34;").replace(/\'/g,"&c39;").replace(/\\/g,"&c92;").replace(/\0/g,"&c0;").replace(/\n/g,"&c10;").replace(/\r/g,"&c13;").replace(/\//g,"&c47;").replace(/\@/g,"&c64;").replace(/\+/g,"&c43;"))};f=function(p){return unescape(p).replace(/&c43;/g,"+").replace(/&c64;/g,"@").replace(/&c47;/g,"/").replace(/&c13;/g,"\r").replace(/&c10;/g,"\n").replace(/&c0;/g,"\0").replace(/&c92;/g,"\\").replace(/&c39;/g,"'").replace(/&c34;/g,'"').replace(/&c38;/g,"&")}}n=function(t,r){var s=typeof t==="string",q=typeof r==="string";if(!s||!q){return s&&!q?1:(!s&&q?-1:0)}t=t.split(".");r=r.split(".");if(t.length!==3||r.length!==3){throw new Error("Invalid version format")}var v=0,u=0;for(var p=0;p<3;p++){v=parseInt(t[p],10);u=parseInt(r[p],10);if(v!==u){return(v>u)?1:-1}}return 0};e=function(p,q){if(Object.prototype.hasOwnProperty){return p.hasOwnProperty(q)}return typeof p[q]!=="undefined"&&p.constructor.prototype[q]!==p[q]};g=function(v){var w,t,y,x,u,q;w={};t=v.split("&");for(u=0,q=t.length;u<q;u++){x=t[u].indexOf("=");w[t[u].substr(0,x)]=decodeURIComponent(t[u].substr(x+1))}return w};m=function(v){var s=v.split("."),t,r,q,u;v=window;for(r=0,q=s.length;r<q;r++){u=s[r];if(u==="parent"){v=v.parent}else{if(u==="opener"){v=v.opener}else{if(u==="top"){v=v.top}else{if((t=k.exec(u)||h.exec(u))){v=v.frames[t[1]]}else{throw new Error("Invalid Target: "+v)}}}}}return v};o=function(){var u,t,r,q,p,w=g(window.location.hash.substr(1)),v=b(window.name);if(w.target){t=m("parent."+w.target);q=w.url}else{t=m("parent.opener."+v.target);q=v.url}if(v&&t&&q){r=q.split("/")[2];p=v.version;u=(t.YUI&&t.YUI.util&&t.YUI.util.CrossFrame)?t.YUI.util.CrossFrame:t.YAHOO.util.CrossFrame;try{if(navigator.userAgent.indexOf("Firefox")>-1){t.setTimeout(function(){u._receive([v.sig,v.body].join("|"),r,q,p)},0)}else{u._receive([v.sig,v.body].join("|"),r,q,p)}}catch(s){}}else{throw new Error("Missing required params")}};function d(r,s,q,p){a.util.CrossFrame._receive(r,s,q,p)}var j;j={proxyReceive:o,parseTarget:m,constructMessage:c,deconstructMessage:b,escapeAttr:i,unescapeAttr:f,compareVer:n,_receive:d};return j})();if(typeof YUI!=="undefined"&&YUI){YUI.namespace("util.CrossFrame");YUI.add("omCrossframe",function(a){},"1.0.0",{requires:[]});(function(d){var u="1.1.16",p=YUI.util.CrossFrame;var h="OM_VBS_Wrapper",b="OM_VBS_GetWrapper",s="OM_VBS_HandleMessage",m="OM_VBS_CreateChannel",j,v=window.location.toString(),i,x,n,y;i=YAHOO.util.CrossFrame.parseTarget;x=YAHOO.util.CrossFrame.compareVer;function o(D,C,B,e){if(D&&D.addEventListener){D.addEventListener(C,B,e)}else{if(D&&D.attachEvent){D.attachEvent("on"+C,B)}}}function g(e){if(e.stopImmediatePropagation){e.stopImmediatePropagation()}else{if(e.stopPropagation){e.stopPropagation()}}e.cancelBubble=true}n=function(D){var e=(d.Lang.isString(D))?D.replace(/#$/,""):false,C=document.getElementsByTagName("iframe"),B;for(B=0,l=C.length;B<l;B++){if(C[B].src.replace(/#$/,"")===e||C[B].contentWindow.location===D){return C[B]}}return null};y=function(D){var B=(typeof D==="object")&&(D!==null)&&(typeof D.sig==="string")&&(typeof D.body==="string")&&(D.sig.length>2)&&(D.body.length>0);if(B){try{if(x(D.version||"1.0.15","1.0.15")<1){}else{B=(x(D.version,D.version)===0)}}catch(C){B=false}}return B};var z,q,k,a,t,A,r,f,c;k=YAHOO.util.CrossFrame.constructMessage;a=YAHOO.util.CrossFrame.deconstructMessage;t=YAHOO.util.CrossFrame.escapeAttr;A=YAHOO.util.CrossFrame.unescapeAttr;if(window.postMessage||document.postMessage){r=!window.postMessage;o(window,"message",function(B){var C,D,E,G;B=B||window.event;try{G=a(B.data);if(y(G)){D=B.origin;E=D.split("/")[2];C=n(B.source.location);if(self===top){g(B)}p.fire("receiveMessage",[G.sig,G.body].join("|"),E,D,C,G.version)}else{}}catch(F){d.log("crossframe.js:onMessageListener: error msg["+F.message+"]")}},false);z=function(E){var B,D,C=i(E.target),e=E.version||u;if(!C){return false}if(r){C=C.document}D=k(E.message,E.sig||"",e);C.postMessage(D,E.proxy);E.handler.call(window);return true}}else{if(window.ActiveXObject){j={};window[s]=function(e,H,I,F){var E=arguments.length,D,C,B,G;window.setTimeout(function(){try{if(E===1){D=JSON.parse(e);e=D.uri;H=D.sig;I=D.message;F=D.version}else{e+="";H+="";I+="";F+=""}C=n(e);B=e.split("/")[2];p.fire("receiveMessage",[H,I].join("|"),B,e,C,F)}catch(J){}},0)};window[m]=function(e,B){j[e]=B};vbscript=["Class "+h+"\n ","Private m_Intended\n","Public Sub SetIntendedName(name)\n ","If isEmpty(m_Intended) Then\n","m_Intended = name\n","End If\n","End Sub\n","Public Sub SendMessage(data)\n ",s+"(data)\n","End Sub\n","Public Sub SendMessage2(uri, sig, message, version)\n ","Call "+s+"(uri, sig, message, version)\n","End Sub\n","Public Sub CreateChannel(channel)\n ","Call "+m+"(m_Intended, channel)\n","End Sub\n","End Class\n","Function "+b+"(name)\n","Dim wrap\n","Set wrap = New "+h+"\n","wrap.SetIntendedName name\n","Set "+b+" = wrap\n","End Function"].join("");try{window.execScript(vbscript,"vbscript")}catch(w){}}z=function(E){var B,C;E.version=E.version||u;E.sig=E.sig||"";E.uri=v;try{B=E.targetId||"parent";if(B=="parent"){C=j.parent;if(!C&&window.opener&&"CreateChannel" in window.opener){C=window.opener;C.CreateChannel(window[b]("parent"));j.parent=C;window.opener=null}if(C){if("SendMessage2" in C){C.SendMessage2(E.uri,E.sig,E.message,E.version)}else{C.SendMessage(JSON.stringify(E))}E.handler.call(window);return true}}else{if(j[B]){if("SendMessage2" in j[B]){j[B].SendMessage2(E.uri+"",E.sig+"",E.message+"",E.version+"")}else{j[B].SendMessage(JSON.stringify(E))}E.handler.call(window);return true}}}catch(D){}c.send(E)};c=(function(){var e=(function(){var C=0;return function(){return"om_xdm_proxy"+C++}})();q=function(D){function C(){var E=document.getElementById(D);E.getElementsByTagName("iframe")[0].onload=null;if(E.parentNode){E.parentNode.removeChild(E)}E=null}p.mapHandlers[D].call(window);delete p.mapHandlers[D];if(navigator.userAgent.indexOf("Firefox")>-1){setTimeout(C,0)}else{C()}};var B=function(E){if(!document||!document.body){setTimeout(function(){z(E)},20);return}var I=E.proxy,G=E.target,O=E.message,L=E.handler,N=E.sig||"",H=E.version||u;if(!i(G)){L();return false}if(window.ActiveXObject&&x(H,"1.1.9")>=0){var J=new ActiveXObject("htmlfile");J.open();J.parentWindow.opener=window;J.parentWindow.callback=function(){J=null;L()};J.write(["<html><head></head><body>",'<iframe src="',I,'" name="',k(O,N,H,G,v),'"></iframe>',"<script>onload = callback;<\/script>","</body></html>"].join(""));J.close()}else{var K=[I,"#","target=",encodeURIComponent(G)+"&url=",encodeURIComponent(v)].join(""),F,D,C=document.createElement("div"),M=C.style;D=e();p.mapHandlers[D]=L;F=["<iframe onload=\"YAHOO.util.CrossFrame.iframeOnload('",D,'\');" name="',k(O,N,H),'" src="',K,'"></iframe>'].join("");M.width=M.left=M.top=M.height="0";M.overflow="hidden";M.position="absolute";C.id=D;document.body.appendChild(C);C.innerHTML=F}return true};return{send:B}})()}d.mix(p,{_events:{},on:function(e,C){var B=this._events;if(!B[e]){B[e]=[C]}else{B[e].push(C)}},fire:function(C){var E=this._events[C]||[],B=Array.prototype.slice.apply(arguments,[1]);for(var D=E.length;D--;){try{E[D].apply(null,B)}catch(F){}}},send:z,mapHandlers:{},_receive:function(D,E,C,e){var B=n(C);p.fire("receiveMessage",D,E,C,B,e)},initIEFrameTransport:function(e,C){var B;if(window.ActiveXObject&&!window.postMessage){B=window[b](C);e.contentWindow.opener=B}},proxyReceive:YAHOO.util.CrossFrame.proxyReceive},true);YAHOO.util.CrossFrame.iframeOnload=q})(YUI())}}if(typeof YUI!=="undefined"&&YUI&&!(YUI.om&&YUI.om.Iframe)){YUI.namespace("om.Iframe");(function(b){var d=[],f=[],j,c,g,i,e=true,h=YUI.util.CrossFrame;j=function(v,o,m,p,s){var k=v.indexOf("|"),u=v.substr(0,k),t,q,n;v=v.substr(k+1);for(q=0,n=d.length;q<n;q++){t=d[q];if(t.sig){if(!u||(t.sig!==u)){continue}}if(t.filter&&((t.filter.exec&&!t.filter.exec(m))||(t.filter.call&&!t.filter.call(null,m)))){continue}if(t.handler){try{t.handler.apply(t.scope,[{iframe:p,version:s},v.substr(4)])}catch(r){b.log("Exception in user defined handler","om.Iframe","iframe.js")}}}};h.on("receiveMessage",j);c=function(k){if(!k.pattern||!k.pattern.test||!k.handler||!k.handler.call){return false}d.push(k);return true};i=function(o,q,p,m,k,n){f.push({proxy:o,target:q,message:p,handler:g,sig:m,version:k,targetId:n});if(!e){g()}};g=function(){if(!f.length){e=false;return}e=true;h.send(f.shift())};YUI.om.Iframe={listen:c,send:i};function a(k){if(/in/.test(document.readyState)){setTimeout(function(){a(k)},9)}else{k()}}if(window.postMessage||document.postMessage||(top==self)){g()}else{if(document.addEventListener){document.addEventListener("DOMContentLoaded",g,false)}else{a(g)}}})(YUI())};YUI.add("om-controller-crossframe",function(C){var M=C.om,E=M.Controller,N=E.extend("Crossframe"),L=E.Openapi,D=M.common.Errors,K=M.common.Utils,F=M.model.DataStore,H=F.Registry,A=false,B=C.common.Utils.rocketstats;function G(R,S,T,P){var O=R.iframe,W=null,V={},Q,U=R.version||"1.0.15";if(K.compareVer(U,"1.0.16")<0&&P){throw new Error("initAPI: bad API, crossframe version");}if(O!==null){W=F.ViewRegistry.get(O.id);V={cbid:S||null,apiVersion:T,version:U,skipURIEncode:P,iframe:O,proxy:O.src.split("/").slice(0,3).join("/")+"/om/xdm_proxy?bn="+NeoConfig.om.xdmproxyVer,widget:W,appid:W&&W.get("appId"),instanceid:W&&W.get("instanceId"),id:W&&W.get("viewId"),parameters:W&&W.get("params")};for(Q=frames.length-1;Q>=0;--Q){if(frames[Q]===O.contentWindow){return V;}}}throw new Error("initAPI: invalid message origin");}function I(V,T){var Q,P,S=false;try{Q=C.JSON.parse(T);S=true;}catch(U){}if(C.Lang.isUndefined(Q)){Q=C.JSON.parse(decodeURIComponent(T));}var O=G(V,Q.$cbid,Q.$apiVersion,S),R=L.publicAPIs[Q.$cmd];if(R){if(!A&&H.isMessenger(O.appid)){A=true;C.fire("Y.om.controller:launchIM:complete");}L.enforceRules(Q.$cmd,O,Q);}else{P={error:D.ERR_UNSUPPORTED_BY_HOST};L.returnAPI(O,P,true);}}function J(R){var P="https?://(?:[a-z0-9]+(-|\\.))?",O="(?:"+K.escapeDots(NeoConfig.om.webcacheHostNet)+")",S="(?:"+K.escapeDots(NeoConfig.om.webcacheHostCom)+")";try{YUI.om.Iframe.listen({pattern:/^cmd=([\s\S]*)$/,handler:R,filter:new RegExp(["^",P,"(?:",O,"|",S,")","(?:/|$)"].join(""))});K.log("INIT Crossframe handler");}catch(Q){K.log("neo:OM:crossframe:setListenerHandler: YUI.om.Iframe missing, check if neo loaded openmail crossframe correctly. message=["+(Q.message||"")+"]");B.stat("OM",["OM:ERR:setListenerHandler",Q.message].join(":"));}}J(I);C.mix(N,{publicHandler:I,setListenHandler:J},true);},"1.0.0",{requires:["om-controller-base","om-common-utils","om-controller-openapi","omCrossframe","rocket-stats"]});YUI.add("om-controller-views",function(E){var e=E.om,L=e.Controller,s=e.common.Errors,g=L.extend("Views"),t=e.common.Utils,v=e.model.DataStore,n=v.Registry,f=v.ViewRegistry,G=v.EventRegistry,U=v.OpenViewLog,j=v.APP_FLAGS,T=E.common.Utils,r=T.substitute,W="om_user_view_id_",l="om_default_view_id_",A=E.Lang,c=E.Array,H=T.rocketstats,K=[NeoConfig.lang?NeoConfig.lang.replace(/-x-.*$/,""):"en-US"],k=NeoConfig.om.intl?NeoConfig.om.intl.replace(/_.*$/,""):"us",N=NeoConfig.om.intl?NeoConfig.om.intl.replace(/^.*_|^.*$/,""):"";function O(w,Y){return W+w+"-"+Y;}function h(w,Y){return l+w+"-"+Y;}function F(w,Y){return h(w,Y)+"_"+new Date().getTime();}function B(w,Y,x){if(x.target_zone==="messagepane"){return F(w,Y);}return x.id?O(w,x.id):h(w,Y);}function b(w){var Y="";if(w.indexOf(W)===0){Y=w.indexOf("-")+1;return w.substring(Y);}return w;}function d(){return"&cb="+(new Date()).getTime();}function J(x,w){var Y=n.get(x);if(Y&&Y[w]){return Y[w];}}function m(AA,x){var Y=n.isInternal(AA),y=J(AA,"status")&j.SANDBOXED,w=(Y&&!y)?NeoConfig.om.webcacheHostCom:NeoConfig.om.webcacheHostNet,AB=(NeoConfig.om.webcacheHostCom.indexOf("yahoo.com")!==-1&&NeoConfig.om.webcacheHostCom.indexOf(".corp.")!==-1),z="-";return NeoConfig.launch_protocol+(!AB?[AA,z,w].join(""):w);}function u(AF,AD,AH,AG){var x,w=NeoConfig.farm?NeoConfig.farm.substring(1):"",z=c.hash(["9323","323","372","6193"]),y=NeoConfig.om.xdmproxyVer,AB=NeoConfig.isFullSSL,AC=n.isInternal(AH),AA=[m(AH,AB),"/om/api/1.0","/openmail.app.invoke"].join(""),AE=[AH,J(AH,"version"),y,NeoConfig.om.intl,NeoConfig.lang,AF,AB?"1":"0"],Y={bn:y,".lang":NeoConfig.lang,".intl":NeoConfig.om.intl,rtl:NeoConfig.isRTL?"1":"0",proxyhost:NeoConfig.servername,sig:t.getAppSignature(AH),vid:b(AG),app:AH,mailver:"neo"};if(w in z){Y.farm=w;}if(AB){Y.proxyssl=1;}x=[AA,"/",AE.join("/"),"#",E.QueryString.stringify(Y),AC?"&crumb="+NeoConfig.om.crumb:""].join("");return x;}function P(Y){var w=f.get(Y);if(w){t.log("openview: view["+w+"] already running, no need to openView");}return !!w;}function C(AC,AF,AA,AB,z,w,AE,x,Y,y,AD){E.use("om-ui-views-hidden",function(AI){if(P(AC)){return;}var AH=u(AB,z,AF,AC),AG=new AI.om.ui.views.Hidden({appId:AF,instanceId:AA,viewId:AC,params:AE,url:AH,elementAttributes:y});f.set(AC,AG);AG.on("load",function(){if(AD){AD(AG);}});AG.render();});}function D(AC,AF,AA,AB,z,w,AE,x,Y,y,AD){E.use("om-ui-views-simple","_shared_module_open_mail_application_messagepane",function(AI){if(P(AC)){return;}var AH=u(AB,z,AF,AC),AG=new AI.om.ui.views.Simple({template:AI.ui.Templates._shared_module_open_mail_application_messagepane,appId:AF,instanceId:AA,viewId:AC,params:AE,url:AH,elementAttributes:y});f.set(AC,AG);if(AD){AD(AG);}});}function X(Y,AA,y,x,w,z,AB){E.use("om-ui-views-folderpane",function(AD){if(P(Y)){return;}var AC=new AD.om.ui.views.FolderPane({appId:AA,instanceId:y,viewId:Y,params:w.parameters,url:x,height:w.height,hidden:w.hidden,elementAttributes:z});f.set(Y,AC);AC.on("load",function(){if(AB){AB(AC);}});AC.render();AD.on("scroll",t.onIdle(function(){AD.fire(t.getEventName(null,"folderpane.scroll"),{});},200),(NeoConfig.fullPage)?window:"#shellnavigation");});}function V(AC,AG,z,AA,y,w,AF,Y,AE,AB,AH,x,AD){E.use("om-ui-views-alignedoverlay",function(AJ){if(P(AC)){return;}var AI=new AJ.om.ui.views.AlignedOverlay({appId:AG,instanceId:z,viewId:AC,params:AF,url:AA,width:Y,height:AE,elementAttributes:x,options:AH||{}});f.set(AC,AI);AI.on("load",function(){if(AD){AD(AI);}});AI.render.apply(AI,AH.renderParams||[]);});}function R(AC,AG,z,AA,y,w,AF,Y,AE,AB,AH,x,AD){E.use("om-ui-views-panel",function(AJ){if(P(AC)){return;}var AI=new AJ.om.ui.views.Panel({appId:AG,instanceId:z,viewId:AC,params:AF,url:AA,width:Y,height:AE,elementAttributes:x,options:AH||{}});f.set(AC,AI);AI.on("load",function(){if(AD){AD(AI);}});AI.render.apply(AI,AH.renderParams||[]);});}function S(y,Y,x){var w=G.getByEventName(y,Y,x);if(w){E.detach(x,w.listenerFn);G.del(y,Y,x);}}function I(x,Y){var y=G.getByViewId(x,Y),w;if(y){for(w in y){S(x,Y,w);}}}function Q(w){if(!w){T.assert(false);return;}var Y=w.get("viewId"),x=w.get("instanceId");U.del(Y);f.del(Y);I(x,Y);}function q(z,AP,AR,AK,AQ,AT,x,AB,AL,AI,AF,AU,AD,AM,Y,AG,AC,y,AA){H.stat("OM","APP:INVOKE:"+z);U.set(AR,arguments);AP=AP||J(z,"instance");y=y||{};function AS(AV){if(AA){AA(AO);}}var AJ={title:y.elementTitle?T.escapeHtml(y.elementTitle):n.getAppName(z)},AO={},w=[AT],AE=[],AH={appId:z||null,context:x||null,data:AB||{},reason:AD||null,theme:"",user:{cobrand:N,guid:NeoConfig.neoguid,intl:k,lang:K.slice(),bidi:!!NeoConfig.bidi,isRTL:!!NeoConfig.isRTL,useRichText:E.common.persist.UserData.get("userUIPref.useRichText"),theme:"",themeinfo:NeoConfig.theme?{name:NeoConfig.theme.id,css:NeoConfig.theme.url}:{}},version:"2"};if(n.isInternal(z)){AH.fullPage=NeoConfig.fullPage;AH.isFresh=NeoConfig.isFresh;AH.instanceId=AP||null;AH.isAMT=NeoConfig.isAMT;AH.urlParams=T.parseQueryString();AH.wssid=NeoConfig.wssid;if(N&&!c.some(AH.user.lang,function(AV){return AV===NeoConfig.lang;})){AH.user.lang.unshift(NeoConfig.lang);}}if(AG){AH.actionType=AG;}try{if(Y&&Y.className&&(Y.className.indexOf("subAppRow")>-1)){AE=Y.id.split("_");AH.index=AE[AE.length-1];}}catch(AN){}switch(AT){case"alignedoverlay":V(AR,z,AP,u(AK,AQ,z,AR),AQ,x,AH,AL,AI,AU,y,AJ,AS);break;case"panel":R(AR,z,AP,u(AK,AQ,z,AR),AQ,x,AH,AL,AI,AU,y,AJ,AS);break;case"folderpane":y.parameters=AH;X(AR,z,AP,u(AK,AQ,z,AR),y,AJ,AS);break;case"overlay":y.parameters=AH;w.push(AR,z,AP,u(AK,AQ,z,AR),y,AJ,AS);break;case"tab":w.push(AR,z,AP,u(AK,AQ,z,AR),AQ,x,AH,AU,AD,AJ,AS,y);break;case"lightbox":w.push(AR,z,AP,u(AK,AQ,z,AR),AQ,AH,AJ,AS);break;case"bubble":case"dialog":if(!AL){AL=400;AO={errorMsg:"No width specified - defaulting to 400",warn:s.ERR_BAD_ARG};}if(!AI){AI=400;AO={errorMsg:"No height specified - defaulting to 400",warn:s.ERR_BAD_ARG};}w.push(AR,z,AP,u(AK,AQ,z,AR),AQ,x,AH,AL,AI,AU,AJ,AS);break;case"hidden":C(AR,z,AP,AK,AQ,x,AH,AF,AD,AJ,AS);break;case"uninstall":C(AR,z,AP,AK,AQ,x,AH,AF,AD,AJ,AA);break;case"messagepane":if(NeoConfig.om.isSandboxEnabled){D(AR,z,AP,AK,AQ,x,AH,AF,AD,AJ,AA);
}break;default:AO={error:s.ERR_INVALID_TARGET,errorMsg:"Target '"+AT+"' not supported."};AS();}if(w.length>1){E.use("om-controller-views-other",function(AV){g.handleView.apply(null,w);});}}function p(w,x,AA,Y){T.assert(x==="data"||x==="events");var z;try{z=w.config[x][AA].action;}catch(y){if(Y){z={launch:{view:"full",target_zone:"tab",context:null}};}}return z;}function Z(Y){Y.close();Q(Y);Y.destroy();}function a(w){var Y=f.get(w),x=Y&&Y.get("instanceId"),w=Y&&Y.get("viewId");if(!Y||Y.get("closing")){return;}Y.set("closing",true);Z(Y);}function M(w,x){var Y;if(!n.isInDb(w)){if(!x){E.use("common-ui-dialog-helper",function(AA){var z={hd:strings["str_om_error_app_not_found_title"],bd:strings["str_om_error_app_not_found_body"]};function y(){AA.use("om-controller-addremoveapp",function(AB){L.AddRemoveApp.uninstallApp(w.app);});}AA.common.ui.DialogHelper.confirm(z,{ok:{handler:y}});});}return false;}if(n.isRevoked(w)){if(!x){Y={source:"unpublish",noConfirmDialog:true};E.use("common-ui-dialog-helper",function(z){function y(){z.use("om-controller-addremoveapp",function(AA){L.AddRemoveApp.uninstallApp(w.app,Y);});}z.common.ui.DialogHelper.alert({hd:strings["str_om_error_app_nonexistant_title"],bd:strings["str_om_error_app_nonexistant_body"]},{ok:{handler:y}});});}return false;}if(n.isSick(w)){if(!x){E.use("common-ui-dialog-helper",function(y){y.common.ui.DialogHelper.alert({hd:strings["str_om_error_app_unavailable_title"],bd:r(strings["str_om_error_app_unavailable_body"],{app_name:w.label})});});}return false;}return true;}function i(AG,AE,AJ,y,w,Y,AA,AC,z,AD){T.assert(!AA);if(!AG||!AG.config||AG.app=="retry"){E.use("om-controller-applicationlist",function(AN){if(AG.app=="retry"){L.ApplicationList.loadApplication();}else{L.ApplicationList.getApplicationConfigs(function(AO){if(AO){i(n.get(AG.app),AE,AJ,y,w,Y,AA,AC,z,AD);}else{return;}});}});return;}if(!M(AG,AC)){return;}var x={};if(AG.needsAck){t.log("preinstall: "+AG.name);x={callback:function(AN){if(!AN.error){i(n.get(AG.app),AE,AJ,y,w,Y);}},appStatus:AG.status,appName:AG.name,developerName:AG.developer_name,description:AG.description,source:"preinstall"};E.use("om-controller-addremoveapp",function(AN){L.AddRemoveApp.installApp(AG.app,x);});return;}var AB=p(AG,AE,AJ,y),AF,AL,AK,AM,AI,AH=(AE==="data")?"data/message":(AE+"/"+AJ);for(AF in AB){AL=AB[AF];T.assert(AF=="launch");if(!AG.views[AL.view]){E.use("common-ui-dialog-helper",function(AN){AN.common.ui.DialogHelper.alert({hd:strings["str_om_error_app_unavailable_title"],bd:r(strings["str_om_error_app_unavailable_body"],{app_name:AG.label})});});return false;}AI=w;AK=B(AG.app,AJ,AL);AM=(AL.target_zone==="uninstall")?AG.label:(AL.title||AG.label);if(n.isMessenger(AG.app)){if(!NeoConfig.isCorpmail){E.fire("Y.om.controller:launchIM:start");}}E.each(AL.options,function(AP,AO){var AQ=(AP==="true"||AP==="1"),AR=(AP==="false"||AP==="0"),AN=AQ||AR;x[AO]=AN?(AQ||!AR):AP;});q(AG.app,AG.instance,AK,AL.view,AG.views[AL.view].type,AL.target_zone,AL.context,AI||null,AL.width,AL.height,AL.ttl,AM,AH,null,Y,AJ,z,x,AD);}}function o(z,y){var x=f.getAll(),w,Y;for(w in x){Y=x[w];if(z===Y.get("appId")&&y===Y.get("instanceId")&&!Y.get("closing")){a(w);}}E.fire("om:close_application"+y,y);}E.mix(g,{openView:q,closeView:a,closeApplication:o,getInternalViewId:B,getInternalUserViewId:O,getInternalDefaultViewId:h,isOpened:P,runActions:i},true);},"1.0.0",{requires:["common-utils","om-controller-base","om-common-utils","om-model-datastore","om-controller-crossframe","om-common-errors","querystring-stringify-simple"]});YUI.add("_shared_module_open_mail_application_list_menu",function(A){A.namespace("ui.Templates");A.ui.Templates._shared_module_open_mail_application_list_menu={base:'<div id="menu-applist" class="optionMenu"> <ul> <li data-action="app-remove"><a href="#"><span>{{str_menu_remove}}</span></a></li> </ul></div>'};},"1.0.0");YUI.add("om-ui-applicationlist-base",function(F){var E=F.common.Utils,D=F.Lang,A=E.substitute,C=F.common.persist.getCookie();var B=function(){var W=this,M=F.om,g=M.common.Utils,H=M.model.DataStore,Y=H.ApplicationList,S=H.ApplicationSubFolderList,U=H.Registry,P=H.APP_FLAGS,c=F.ui.Templates._shared_module_open_mail_application_list,L=F.one("#nav-applications"),T=F.one("#app-list"),X="om.applex",K=F.common.Utils.rocketstats,N=M.Controller,f=true,b={appList:function(h){if(h){var o={app_id:"retry",app_status:P.PUBLIC,app_row_id:"_app_retry",app_icon_url:"",app_name:strings["str_om_app_list_retry"]},r=A(c.application_list,o,b);return r.replace(/<img [^>]*>/i,"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");}var m,p="",t,o,k=Y.getAll(),q=Y.getSpriteURL(),n,l,j=H.Registry.hasOldAndNewCalendarApps();q=V(q);for(m in k){t=k[m];if(typeof t.image_url=="number"){l=t.image_url*16;n=true;}else{l=0;n=false;if(t&&t.image_url){t.image_url=V(t.image_url);}}o={app_id:t.app,app_status:t.status,app_row_id:"_app_"+t.app,app_name:t.label+(!(t.status&P.PUBLIC)?" (Private)":""),app_icon_url:n?q:t.image_url.replace(/<!--IMAGE_TYPE-->/,"icon"),app_icon_pos:(NeoConfig.isRTL?" 100%":" 0px ")+" -"+l+"px",app_row_name_id:"_app_name_"+t.app,app_row_info_id:"_app_info_"+t.app};if(H.Registry.isNoAppList(t)&&H.Registry.isPublic(t)){continue;}if(j&&H.Registry.isOldCalendarApp(t)){continue;}p+=A(c.application_list,o,b);}return p;},application_refresh:function(i){var k=i.app_id,h,j="";if(!(i.app_status&H.APP_FLAGS.PUBLIC)){h={app_ref_id:"_ref_"+k,app_refblock_id:"_refblock_"+k};j=A(c.application_refresh,h,b);}return j;},application_list_subfolder:function(i){var l=i.app_id,h,j,k="";j=S.get(l);if(j&&j.length>0){h={app_id:l,app_subfolder_div_id:"_sub_container_"+l};k=A(c.application_list_subfolder,h,b);}return k;},application_list_subfolder_row:function(k){var m,o=k.app_id,j,p,l,n="";l=S.get(o);for(m in l){var h=l[m];j={app_sub_folder_row_id:"_sub_"+o+"_"+m,app_sub_folder_label:"- "+h.label,app_sub_folder_tooltip:h.tooltip||h.label,app_sub_folder_count:typeof(h.count)!="undefined"?h.count:null};n+=A(c.application_list_subfolder_row,j,b);}return n;},application_list_subfolder_count:function(i){var k=i.app_sub_folder_count,h,j="";if(k!=null){h={app_sub_folder_count:k};j+=A(c.application_list_subfolder_count,h,b);}return j;},application_count:function(i){var h,k="",j=i.count;if(typeof(j)!="undefined"){h={app_folder_count:j,count:j};k+=A(c.application_count,h,b);}return k;},application_count_markup:function(i){var h,k="",j=i.count;if(typeof(j)!="undefined"){h={app_folder_count:j};k+=A(c.application_count_markup,h,b);}return k;}};function G(k,l){var j,i="subfolder.click",h={};j=H.Registry.get(k).instance;h={app:k,index:l,instance:j};F.fire(g.getEventName(j,i),h);}function J(){var h;if(!T.one('a[tabindex="0"]')&&(h=T.one("a[role=option]"))){h.set("tabIndex",0);}return h;}function a(){var h=F.one("doc").get("activeElement");return(T.contains(h)?T.all("a[role=option]").indexOf(h):-1);}function I(k){var j=T.all("a[role=option]"),i=j.item(k),h;if(!i){h=k+1;if(h>j.size()){h=k-1;}i=j.item(h);}if(i){i.set("tabIndex",0);i.focus();}}function Z(){var h=F.one("#apps-toggle-btn");F.on("om:updateFolders",function(m,l){var n=L.ancestor("div"),p,k=a(),o;o=C.get(X);if(!NeoConfig.isFresh){p=o>0?1:0;}else{p=o<2?0:1;}m=m?m:false;if(p==1){n.removeClass("collapsed");n.addClass("expanded");h.set("aria-expanded",true);e(l);f=false;}else{n.removeClass("expanded");n.addClass("collapsed");h.set("aria-expanded",false);if(!m){e(l);}}if(k>=0){I(k);}else{J();}F.one("#nav-applications span.btn").removeClass("hidden");T.removeClass("hidden");});F.on("om:updateSingleFolder",function(p){var w=a(),z,t,y,n,u,o="";if(t=p.config.label){var x=F.one("#_app_name_"+p.ctx.appid),s;if(x){u=x.getContent();s=u.indexOf("(Private)");o=(s>-1)?u.substring(0,s)+t+" "+u.substring(s):u+t;x.setContent(o);}}var l=F.one("#_app_info_"+p.ctx.appid);if(l){if(y=p.config.tooltip){l.setAttribute("title",y);}else{if(o){l.setAttribute("title",o);}}if(n=p.config.count){var r=F.one("#_refblock_"+p.ctx.appid),q;if(r){q=b.application_count_markup({"count":n});q+=r.getContent();r.setContent(q);}else{q=l.getContent();q+=b.application_count({"count":n});l.setContent(q);}}}if(z=p.config.subFolders){var v=p.ctx.appid,k,m=F.one("#_sub_container_"+v);if(m){m.get("parentNode").removeChild(m);}S.set(v,z);d(v);}else{S.del(v);}if(w>=0){I(w);}else{J();}});if(!L){return;}function j(m){var k=L.ancestor("div"),l;if(k){k.toggleClass("collapsed").toggleClass("expanded");if(f){T.set("aria-live","polite");l='<li role="presentation"><span style="padding-left:20px;margin-left:8px;">'+strings["str_om_loading"]+"</span></li>";T.setContent(l);e();f=false;}if(k.hasClass("collapsed")){C.set(X,0);h.set("aria-expanded",false);F.fire("om:list:collapse");F.fire("mt:click",{action:"toggle_applications",append:{ltxt:"collapse"}});}else{NeoConfig.isFresh?C.set(X,2):C.set(X,1);h.set("aria-expanded",true);F.fire("om:list:expand");F.fire("mt:click",{action:"toggle_applications",append:{ltxt:"expand"}});}}}h.on("click",j);h.on("keydown",function(k){switch(k.keyCode){case 13:j(k);break;case 37:k.halt();break;case 38:k.halt();break;case 39:k.halt();L.one(".btn input").focus();break;case 40:k.halt();T.one("li a").focus();break;}});T.delegate("keydown",function(q){var r=q.target,s=q.keyCode,k,m,p,o,t,n,l=F.UA.os;if((l=="macintosh")&&(s==8)){s=46;}switch(s){case 38:if(r===T.one("li a")){q.halt();h.focus();break;}case 40:q.halt();k=q.container.all("a[role=option]");p=k.indexOf(this);o=q.keyCode===40?p+1:p-1;if((m=k.item(o))){r.set("tabIndex",-1);m.set("tabIndex",0);m.focus();}break;case 46:q.halt();t=r.ancestor("li").get("id");if(t.indexOf("_app_")>=0){t=t.slice(5);if(!(H.Registry.isPermanent(t))){F.use("om-controller-addremoveapp",function(u){N.AddRemoveApp.uninstallApp(t);});}}break;case 121:case 77:n=(l=="windows"||l=="win");if((n&&q.shiftKey&&s==121)||(!n&&q.ctrlKey&&q.shiftKey&&q.altKey&&s==77)){q.preventDefault();E.simulateContextMenu(q.target,false);
}break;}},"a[role=option]");T.delegate("click",function(l){var n=l.currentTarget,k,m;l.halt();m=l.currentTarget.getAttribute("id");k=m.slice(5);appData=U.get(k);O(m);R(k);F.fire("om:refreshApp",appData);O(m);},"li input");function i(o){o.halt();var s,u,n,v,t,m,r,p,l,k;n=(o.currentTarget).one("a");s=(o.currentTarget.getAttribute("id")).slice(5);v=U.get(s);K.stat("OM","APPLIST:clickApp");K.stat("OM","APPLIST:clickApp:"+s);m=v&&v.config;t=m&&m.events;r=t&&t["click"];p=r&&r.action;l=p&&p.launch.target_zone;if(l=="window"){K.stat("OM","APP:INVOKE:"+s);k=s;window.open(p.launch.view,k);o.stopPropagation();return;}var q=(o.target).getAttribute("id");if(q.indexOf("_ref_")>=0){return;}u=s.split("_");if(u.length==1){F.fire("om:appclicklaunch",s);F.fire("mt:click",{action:"launch_app",append:{ltxt:s},spid:"om_app_click"});}else{G(u[0],u[1]);}}T.delegate("click",i,"li");F.on("om:appclick",i);T.delegate("contextmenu",function(m){var n=m.currentTarget,l=m.target;if(!n.menu){var k=n.get("id");if(k.indexOf("_app_")>=0){k=k.slice(5);if(!(H.Registry.isPermanent(k))){F.use("om-ui-applicationlistmenu-base","common-ui-menu-helper",function(p,o){p.om.ui.ApplicationListMenu.insert("menu-applist",function(){var q=p.one("#menu-applist");p.common.ui.MenuHelper.create(n,{menu:q,isContext:true,xy:[m.clientX,m.clientY],contextTarget:m.target},function(){q.on("menuSelected",Q,null,k);q.on("menu:state",function(r){if(r.state=="hide"){l&&l.focus();}});});});});}}}m.halt();},"li");L.delegate("click",function(l){var k=U.getGalleryData();if(k&&k.app){F.fire("om:appclicklaunch",k.app);}else{}F.fire("mt:click",{action:"open_gallery",spid:"om_app_click"});l.halt();},"input");L.delegate("keydown",function(k){switch(k.keyCode){case 37:k.halt();h.focus();break;case 38:k.halt();break;case 39:k.halt();break;case 40:k.halt();T.one("li a").focus();break;}},"input");}function Q(i,h){if(i.dataAction&&i.dataAction=="app-remove"){F.use("om-controller-addremoveapp",function(j){N.AddRemoveApp.uninstallApp(h);});}}function O(i){i="#"+i;var h=F.one(i);if(!h.hasClass("loading")){h.addClass("loading");}else{h.removeClass("loading");}}function R(i){var h=H.Registry.get(i).instance;N.Views.closeApplication(i,h);N.Openapi.upgrade(i,h,null,null,true);}function e(h){var i=b.appList(h);T.setContent(i);T.setAttrs("aria-live","off");}function d(j){var h=F.one("#_app_"+j),i=b.application_list_subfolder({app_id:j});h.append(i);}function V(h){if(F.Lang.isString(h)&&!h.match(/^https?:\/\/image-/)){return h.replace(/^https?:\/\//,NeoConfig.launch_protocol+"image-");}return h;}Z();F.mix(W,{render:e});F.om.Controller.ApplicationList.loadApplication();};F.namespace("om.ui");F.om.ui.ApplicationList=new B();},"1.0.0",{requires:["common-utils","_shared_module_open_mail_application_list","om-model-datastore","om-controller-applicationlist","om-controller-views","_shared_module_open_mail_application_list_menu","common-persist-cookie-data"]});YUI.add("om-controller-messageread",function(D){var T=D.om,I=T.Controller,i=I.extend("Messageread"),k=T.common.Utils,m=T.model.DataStore,h=m.Registry,U=m.ViewRegistry,F=m.EventRegistry,J=m.ApplicationConfig,L=D.common.Utils,n=D.mail,B=n.model.DataStore.Messages,K=n.Controller.Messages,Q=D.Array,A=D.Lang,a=D.Object,R=A.isUndefined,d="message.read",Z=k.createLogger("ONREAD");function H(u,AA,t){var z=null,w=u.extend,o=w.openmail,Y=(AA.cbk&&AA.cbk.args&&AA.cbk.args.stopwatch)||null,r=u.mid,p="FILTER: "+r+": ",y=new L.Stopwatch("OMMessageGetPostHook"),x;if(o&&o.isProcessed){Z(p+"This message was already processed");return u;}if(o&&o.onEnhanced){Z(p+"This message is already enhancing by another runningQ. Wait until it's done");x=t(function(){});o.onEnhanced.push(x);return;}Y&&Y.start(1,"MatchOnRead");try{z=C(u);if(!o){o=w.openmail={isProcessed:false,isBodyModified:false,flags:{suppressAttachments:z.suppressAttachments}};}o.context=z;}catch(v){Z(p+"Error Message:"+v.message||"");}if(z&&z.filtersMatched){try{Z(p+"This message can be enhanced. start enhancing");o.onEnhanced=[];function s(){}function q(AC){x(AC);for(var AB in o.onEnhanced){o.onEnhanced[AB](AC);}delete o.onEnhanced;y.stop();}x=t(s);u.inboxservices=AA.origParms.msg.inboxservices||[];f(u,q,Y);}catch(v){Z(p+"JS Error occured, show the original message");x(u);}}else{if(!m.Loading.isLoading()){o.isProcessed=true;Z(p+"This message is not interested by any onRead app. Show the original message");}else{Z(p+"Openmail is still loading.  Result not cached.  Show the original message");}}}function f(w,u,Y){Y&&Y.start(1,"LoadAppsOnRead");var p=w.extend.openmail.context,s=p.msgReadAppData,y=p.launchAppIds,q=k.getObjSize(y),t=w.mid,r="LOADQ: "+t+": ",v,AB,AA,o,x;if(q>0){function z(AF){var AD=NeoConfig.om.onReadAppLaunchTimeout.split("."),AC=q*parseInt(AD[2]),AE;AC=Math.max(AC,parseInt(AD[0]));AC=Math.min(AC,parseInt(AD[1]))*1000;AE=AF.later(AC,this,function(){Z(r+"launch timeout. but let's move to runQ");AF.detach("om:message.read:loadQ|*");j(w,u,Y);return;});Z(r+"# of launch apps("+q+") / total launch timeout("+AC+"ms)");for(o in y){v=s[o];AB=v.appData;AA=AB.app;x=k.getEventName(o,d,null);I.Views.runActions(AB,"events","message_read",true,null);Z(r+AB.name+"("+AB.app+"): launching");AF.once("om:message.read:loadQ|"+x+"registered",function(AG){Z(r+AB.name+"("+AB.app+"): event registered "+AG);q--;if(q===0){AE.cancel();j(w,u,Y);}});}}if(I.Views&&I.Views.runApps&&I.Internalapi){z(D);}else{D.use("om-controller-views","om-controller-internalapi",z);}}else{Z(r+"All apps are already launched");j(w,u,Y);}}function j(AL,AB,w){w&&w.start(1,"RunAppsOnRead");var AH=AL.extend,q=AH.openmail,p=q.context,o=p.msgReadAppData,u=p.matchedAppIds,AJ=l({data:c(AL)},d),y=new D.AsyncQueue(),AC=AL.mid,z="RUNQ: "+AC+": ",s="om:message.read:runQ:"+AC+"|",Y,v,AG,r,AF,t,AI,x=false,AA=false,AK,AD=(document.location.host.indexOf("corp.yahoo.com")!==-1);for(AK in m.MessageReadRunList.getAll()){if(AC!=AK){Y=m.MessageReadRunList.get(AK);if(Y){Y.queue.stop();delete Y.omExtend.onEnhanced;D.detach("om:message.read:runQ:"+AK+"|*");m.MessageReadRunList.del(AK);Z(z+"STOP runningQ for message(mid:"+AK+"), another runningQ for the current message has started");}}else{Z(z+"There is already runningQ for the same message (mid:"+AK+")");}}m.MessageReadRunList.set(AC,{queue:y,omExtend:q});function AE(AM){y.add(function(){y.pause();var AN=D.later(parseInt(NeoConfig.om.onReadAppRunTimeout)*1000,this,function(){Z(z+"TIMEOUT "+AM);D.fire(d+AC,AJ);});D.once(s+d+AC,function(AR,AS,AP){AN.cancel();if(AR.returnCode==="success"){V(AR.data,AS);Z(z+"RETURN: SUCCESS "+AM);if(AR.data.data){q.isBodyModified=true;AJ.data.body.content=AR.data.data;}if(A.isUndefined(AJ.data.om_flags)){AJ.data.om_flags={};}if(AR.data.suppressAttachments){AJ.data.om_flags.suppressAttachments=AR.data.suppressAttachments;}if(AR.data.imagesBlocked){AA=true;}if(AA){AJ.data.imagesBlocked=true;}if(!AJ.data.onreadScripts){AJ.data.onreadScripts=[];}var AO=h.isInternal(AS)?NeoConfig.om.webcacheHostCom:NeoConfig.om.webcacheHostNet,AQ={context:{appId:AS,instanceId:AP,invokePrefix:("http://"+(AD?AO:([AS,".",AO].join(""))))},scripts:AR.data.scripts||[],css:AR.data.css||[]};AJ.data.onreadScripts.push(AQ);}else{Z(z+"RETURN: OTHERS "+AM);}y.run();});D.fire(AM,AJ);Z(z+"FIRE "+AM);});}for(AF in u){v=o[AF];AG=v.appData;r=AG.app;AI=v.viewId;t=k.getEventName(AF,d,null);x=U.get(AI)&&F.getByEventName(AF,AI,d+r);if(x){AE(t);Z(z+"ADD "+t);}}D.once(s+d+".jserror"+AC,function(){Z(z+"JSERROR");D.fire(d+AC,AJ);});y.on("complete",function(){if(AH&&q){if(q.isBodyModified){q.enhancedBody=AJ.data.body.content;}q.onreadScripts=AJ.data.onreadScripts;if(!A.isUndefined(AJ.data.om_flags)){q.flags.suppressAttachments=!!(AJ.data.om_flags.suppressAttachments||q.flags.suppressAttachments);}if(!A.isUndefined(AA)){q.imgBlocked=AA;AA=false;}q.isProcessed=true;m.MessageReadRunList.del(AC);D.detach(s+"*");y.stop();AB(AL);Z(z+"ALL DONE!");}});y.run();}function V(o,q){var Y="returnMessage: data type error, appId="+q,p=(A.isObject(o)&&!a.isEmpty(o)&&((R(o.scripts)||A.isArray(o.scripts))&&(R(o.css)||A.isArray(o.css))&&(R(o.suppressAttachments)||A.isBoolean(o.suppressAttachments))&&(R(o.imagesBlocked)||A.isBoolean(o.imagesBlocked))));if(!R(o.data)&&!A.isString(o.data)){p=false;delete o.data;}if(!p){Z(Y);}return p;}function c(q){var u={},Y={},s=K.getQueryParams(q),p=q.extend.openmail.context,o=!K.isCertified(q.inboxservices||[]),t=(s.midRequest.blockImages=="all")&&o;L.merge(u,q.header);L.merge(Y,q.flags);var r={from:u.from,to:u.to,cc:u.cc,replyto:u.replyto,subject:u.subject,date:u.sentDate,messageid:q.mid,folderid:s.fid,sourceFolderid:q.sourceFolderInfo&&q.sourceFolderInfo.fid||null,body:{content:q.body.display},flags:Y,annotation:p.scAnnotation||{},attachment:X(s.fid,q.mid,q.attachments),imagesBlocked:!!((q.hasBlockedImages&&o)||(q.imgAttachments&&q.imgAttachments.length&&t)),suppressImages:t,truncated:q.isTruncated,sandboxPrefix:q.yivPrefixNumber};return r;}function N(p,Y,o){var q=p.header;
return{header:{from:q.from,to:q.to,cc:q.cc,bcc:q.bcc,replyto:q.replyto,inReplyTo:q.inReplyTo,sentDate:q.sentDate,receivedDate:q.receivedDate,subject:L.escapeHtml(q.subject)},body:p.body,hasForwardedMsg:p.hasForwardedMsg,isTruncated:p.isTruncated};}function X(p,r,o){var s=[];for(var Y in o){var t=o[Y],q={partId:L.escapeHtml(t.partId),type:L.escapeHtml(t.type),tnefId:L.escapeHtml(t.tnefId),subtype:L.escapeHtml(t.subtype),typeParams:L.escapeHtml(t.typeParams),disposition:L.escapeHtml(t.disposition),dispParams:L.escapeHtml(t.dispParams),size:t.size,encoding:L.escapeHtml(t.encoding),filename:L.escapeHtml(t.filename),contentId:L.escapeHtml(t.contentId),thumbnailurl:t.thumbnailurl};q.url=D.mail.Controller.Messages.getAttachmentUrl(p,r,t.partId,t.tnefId,t.filename,t.subtype);if(q.type=="message"){q.message=N(t.message,p,r);}s.push(q);}return s;}function l(p,Y){var q=D.merge(p),o=q.data.messageid,r=q.data.folderid;switch(Y){case d:q["returnMessage"]=["function( obj ) {",'var _context = { eventName: "',d,'", mid:"',o,'", fid:"',r,'" };','openmail.Application.callWebService( { url:"apps://", method:"GET", parameters:{ cmd:"returnEvent",args:{ ctx:_context, returnCode:"success", data:obj } } } );}'].join("");q["cancel"]=["function( obj ) {",'var _context = { eventName: "',d,'", mid:"',o,'", fid:"',r,'" };','openmail.Application.callWebService( { url:"apps://", method:"GET", parameters:{ cmd:"returnEvent", args:{ ctx:_context, returnCode:"cancel", data:obj } } } );}'].join("");break;case"compose.start":break;}return q;}function C(v){var t=["http://","https://","ftp://"];if(v.extend.openmail&&v.extend.openmail.context&&v.extend.openmail.enhancedBody){Z("This message is cached and get the context from cache");return v.extend.openmail.context;}function p(w){return Q.some(t,function(x){return w.substring(0,x.length)===x;});}function u(x){var AB=x.length,y=Math.max(x.search(/<body[^>]*>/i),0),w=Math.max(x.search(/<\/body>/i),AB),AA=(y!==0||w!==AB?x.substring(y,w):x).replace(/<script[^>]*>[\s\S]*?<\/script>/mig,""),z=AA.match(/<a\s[^>]*href\s*=\s*"[^"]*|\b(ftp|https?):\/\/[^\s<]+/mig)||[],AC=Q.filter(Q.map(z,function(AD){return A.trim(L.unescapeHtml(AD.replace(/^<a\s[^>]*href\s*=\s*"/mi,"").replace(/"[\s\S]*$/mi,"")));}),p);return AC;}function r(){var AC=v.body.display,w=W(AC),x=w?G(w):{filterInfo:{},scAnnotation:{}},AD=x.filterInfo,AA=x.scAnnotation,AB=Q.hash((AD.url||[]).concat(AD.http||[])),z=Q.unique(u(AC)),y=Q.filter(z,function(AE){return !(AE in AB);});Q.each(y,function(AE){if(!AD.url){AD.url=[];AA.url=[];}AD.url.push(AE);AA.url.push({id:D.guid(),text:AE,context:""});});return x;}var o=null,s=r(),q={annotation:s.filterInfo||{},flags:v.flags,fid:K.getQueryParams(v).fid,header:{from:v.header.from.email,to:Q.map(v.header.to,function(w){return w.email;}),subject:v.header.subject,"attachment.type":Q.map(v.attachments,function(w){return w.type;}),"attachment.subtype":Q.map(v.attachments,function(w){return w.subtype;}),"attachment.filename":Q.map(v.attachments,function(w){return w.filename;})}},Y={domainKeyOk:!v.header.domainkey||(new RegExp(v.header.domainkeyname+"$","i")).test(v.header.from.email),isSpam:q.fid==="%40B%40Bulk"};o=P(v,q,Y);o.scAnnotation=s.scAnnotation||{};return o;}function P(x,AI,AA){var p={},o={},u={},v={},AE=h.getAll(),w=false,AB=false,AH,AF,s,AD,AJ,Y,y,q,AG,AC,t,z=0;function r(AL,AK){return Q.some(Q(AL),function(AM){try{return AK.test(AM);}finally{AK.lastIndex=0;}});}if(!AA.isSpam){for(s in AE){AF=AE[s];if(!AF){continue;}AD=AF.instance;if(AF.needsAck&&!h.isNoDisclaimer(AF)){continue;}if(h.isSick(AF)){continue;}if(NeoConfig.isFullSSL&&AF.name=="Yahoo! Shortcuts"){continue;}if(!AA.domainKeyOk&&!h.isInternal(AF)){continue;}if((AJ=AF.config)&&(Y=AJ.events)&&(y=Y.message_read)&&(q=y.match)){AH=(y.action&&y.action.launch&&y.action.launch.id)?M(s,y.action.launch.id):e(s,"message_read");w=U.get(AH)&&F.getByEventName(AD,AH,d+s);AG=q["@attributes"].mode;AC=t=0;Q.each(J.MATCH_CATEGORIES,function(AK){var AM=q[AK]||[],AL=Q.filter(AM,function(AP){var AO=AI[AK][AP.name],AN=!A.isUndefined(AO)&&r(AO,AP.regex);Z("FILTER: "+AF.name+" ("+AF.app+"): ["+AK+"/"+AP.name+"]"+(AN?"":" NOT")+" MATCH for "+AP.regex);return AN;});AC+=AM.length;t+=AL.length;});Z("FILTER: "+AF.name+" ("+AF.app+"): "+"matched "+t+" of "+AC+" filters; mode="+AG);o[AD]={appData:AF,totalNumFilters:AC,numFiltersSatisfied:t,viewId:AH};if(((AG==="or")&&(t>0))||((AG==="and")&&(t>0)&&(AC==t))){v[AD]=AD;if(y.message_actions&&y.message_actions.suppress_attachments=="true"){AB=true;}if(!w&&y.action){u[AD]=AD;}if(NeoConfig.om.isMsgReadAppRTB&&h.isMsgReadRtbApp(s)){z++;}}}}}p=k.getObjSize(o)>0?{filterInfo:AI,filtersMatched:k.getObjSize(v)>0?true:false,launchAppIds:u,matchedAppIds:v,autoRun:true,suppressAttachments:AB,msgReadAppData:o}:{filtersMatched:false,launchAppIds:{},matchedAppIds:{},autoRun:true,msgReadAppData:null};if(NeoConfig.om.isMsgReadAppRTB){p.msgReadRtbApps=z;}return p;}function b(o,Y){var q=parseInt(o.split("_").pop(),10),p=parseInt(Y.split("_").pop(),10);return q<p?-1:p<q?1:o.localeCompare(Y);}var E=[{include:/shortcuts:\/us\/(instance)\/(identifier)\/(URL|phone_number|email_address|date_only|date_time|day_of_week|day_of_week_time|month_only|month_year|time_only|vin|.+_tracking|isbn|hyperlink\/http)(\/([\w\W]+))*$/i,exclude:/(other\/health\/drug|organization\/company\/ticker)/},{include:/shortcuts:\/us\/(instance)\/(place|person|organization|event|animal\/fictional|other)(\/([\w\W]+))*/i,exclude:/(other\/health\/drug|organization\/company\/ticker)/i},{include:/shortcuts:\/us\/(tag)\/(other\/technology|news|celebrity|finance\/glossary_mail|other\/wiki)(\/([\w\W]+))*/i,exclude:/(small_business|health\/yahoo_health)/i},{include:/shortcuts:\/us\/(place\/virtual\/web_site)(\/([\w\W]+)*)/i},{include:/shortcuts:\/us\/(class)(\/([\w\W]+))*/i},{include:/shortcuts:\/(concept)(\/([\w\W]+))*/i},{include:/shortcuts:\/(abstract)\/(other|organization|event)(\/([\w\W]+))*/i}];function S(o){var q,r=Q.some(E,function(s){var u=s.include,t;try{if(!(q=u.exec(o))){return false;
}}finally{u.lastIndex=0;}if((t=s.exclude)){try{if(t.test(o)){return false;}}finally{t.lastIndex=0;}}return true;}),p,Y;if(!r){return null;}p=q[2]==="identifier"?q[3]:q[2];Y=q[Math.floor(q.length-1,5)];return{text:o,category:q[1],type:p,subtype:p!==Y?Y:""};}function G(Y){var p=a.keys(Y).sort(b),o=Q.hash(["class","concept"]);return Q.reduce(p,{filterInfo:{},scAnnotation:{}},function(q,s){var t=Y[s],r=a.keys(Q.reduce(t.type,{},function(x,u){var v=S(u),w;if(v){if(v.type&&v.category&&!o[v.category]){w=v.type.replace(/^.*\//,"");}else{w=v.category||v.subtype;}if(w){x[w.toLowerCase()]=true;}}return x;}));Q.each(r,function(u){var v;if(u==="http"){v=L.unescapeHtml((t.metaData||{}).linkHref)||t.text||"";}else{v=t.text||"";}Q.each(a.keys(q),function(w){if(!q[w][u]){q[w][u]=[];}});q.filterInfo[u].push(v);q.scAnnotation[u].push({id:s,text:v,context:t.context});});return q;});}function W(r){var o=r.search(/<script[^>]*>/i),t,Y,q,p;if(o>=0){t=r.length;Y=Math.max(r.search(/<\/script>/i),t);q=o!==0||Y!==t?r.substring(o,Y):r;p=/\bYAHOO\.Shortcuts\.annotationSet\s*=\s*({[\s\S]*?})\s*;/.exec(q);if(p&&p[1]){try{return D.JSON.parse(p[1]);}catch(s){return null;}}}return null;}var O="om_user_view_id_",g="om_default_view_id_";function M(o,Y){return O+o+"-"+Y;}function e(o,Y){return g+o+"-"+Y;}D.mix(i,{postHookMessageGet:H,runMessageReadAppFilters:P,repackageData:c,canEnhanceMessage:C,validateReturnData:V},true);},"1.0.0",{requires:["om-controller-base","om-common-utils","async-queue","mail-controller-messages","common-utils-stats"]});YUI.add("om-ui-messagepane-base",function(G){var d=G.common.Utils,M=G.om,F=M.model.DataStore,a=F.Registry,J=F.ApplicationConfig,O=M.Controller,i=M.common.Utils,f=NeoConfig.om.isSandboxEnabled,L=NeoConfig.servername,b=d.substitute,A=d.onDemand,N=G.ui.Templates,W=(G.UA.ie&&G.UA.ie<8),B=W?6000:4000,R=500,h=W?11000:6000,U=3,c=0,V=["comms-log4js","common-utils-stats","mail-ui-messagepane-utils-shared","openmail_strings","om-ui-messagepane-sandbox-controller","om-ui-sandbox-view","om-ui-sandbox-datastore","om-ui-sandbox-messageread","om-ui-sandbox-utils","common-utils","mail-ui-messagepane-warnings"],T=["attachments_css","mod-conversation-history_css","mod-shortcuts_css"],K=null,D=null,I=d.rocketstats,g=null,C=null;function Z(Y){i.log(Y,"SANDBOX");}function Q(j,Y){return i.getEventName(j,Y);}G.on("om:msg:registerSandboxController",function(Y){if(!g){Z("Controller registered");g=F.ViewRegistry.get(Y.id);G.fire("readpool:check");}});function E(){var m=["launch_css","vitality_css"],k=[],j;for(var n=0,Y=m.length;n<Y;++n){j=G.one("#"+m[n]);if(j){k.push(j.get("href"));}}return k;}function P(){var Y={isRTL:NeoConfig.isRTL,fullPage:NeoConfig.fullPage,hasConv:NeoConfig.hasConv,isFresh:NeoConfig.isFresh,bidi:NeoConfig.bidi,ieCompatibleMode:{ie8_ie7compatible:NeoConfig.ieCompatibleMode.ie8_ie7Compatible,ie9_ie8compatible:NeoConfig.ieCompatibleMode.ie9_ie8Compatible},livewordEventEnabled:NeoConfig.livewordEventEnabled};return{NeoConfig:Y,cssLinks:E(),appConfig:F.Registry.getSandboxMsgReadConfig(),NeoUrlParams:d.parseQueryString()};}G.on("om:msg:getSandboxPostLaunchConfig",function(Y){if(!D){D=P();}O.Openapi.returnAPI(Y,D);});function H(){function Y(l){return l.slice(0,4)=="http";}var k=G.merge(YUI_config.groups.mail_css),j=G.merge((yui.Env._loader||YUI_config).groups.mail);k.modules=G.mix({},k.modules,false,T);j.modules=G.mix({},j.modules,false,V);if(!Y(k.comboBase)){k.comboBase=NeoConfig.launch_protocol+L+k.comboBase;}if(!Y(j.comboBase)){j.comboBase=NeoConfig.launch_protocol+L+j.comboBase;}return{css:k,js:j,strings:strings,mailYUIURL:NeoConfig.yuiURL,mailBase:YUI_config.base,mailComboBase:YUI_config.comboBase,mailLoaderPath:YUI_config.loaderPath,mailModuleRoot:YUI_config.root};}G.on("om:msg:getConf",function(Y){if(!C){C=H();}O.Openapi.returnAPI(Y,{data:C});});function e(Y){if(g&&a.hasMessageReadEvents(Y)){G.fire(Q(g.get("instanceId"),"sandbox.controller"),{cmd:"apprefresh",args:{appConfig:a.getSandboxMsgReadConfig()}});}}G.on("om:refreshApp",e);G.on("om:installApp",e);G.on("om:uninstallApp",e);var S=function(Y,j,k){var l=this;S.superclass.constructor.apply(l,arguments);l.handleContactChanged=G.on("contacts:api:contactChanged",l.updateLozenges,l);if(!f){return;}l.launchStatus="INIT";l.msgRenderTimer=null;l.isSandboxViewReady=false;l.heightUpdateTimer=null;l.sandboxStartTime=null;l.firstRender=1;l.firstMsgDisplayed=false;l.RSstopwatch=null;l.msgReadRtbApps=0;!l.fullView&&G.once("om:msg:registerSandboxController",function(){if(!l.message){l.render();}});l.modifyAttr("scrollWidthActive",{getter:function(){return !l.isSandboxActive();}});};G.extend(S,G.mail.ui.MessagePane);S.prototype.NAME="OMMessagePane";S.prototype.hasOMFlag=function(j,Y){return j.extend&&j.extend.openmail&&j.extend.openmail.flags&&j.extend.openmail.flags[Y];};S.prototype.isSandboxActive=function(){return f&&g&&c<U&&this.launchStatus!=="TIMEOUT";};S.prototype.getEnhancedBody=function(){var k=this,j=k.message,Y=k.isSandboxActive()&&j.extend&&j.extend.openmail&&j.extend.openmail.enhancedBody;return Y||"";};S.prototype.setFullFormatters=function(){var m=this,l=null,j=null,Y=null,k=function(o){var s=o.s||"",q=o.o||0,n=o.f||m.readFormatters,r=o.a||0,p=o.strs||strings;return b(s,q,n,r,p);};if(S.superclass.setFullFormatters){S.superclass.setFullFormatters.apply(m,arguments);l=m.readFormatters.msg_has_attachment;j=m.readFormatters.msg_has_photo_attachment;m.readFormatters.msg_has_photo_attachment=function(){var n=m.message;return m.isSandboxActive()&&(!G.Lang.isUndefined(n.body)&&m.hasOMFlag(n,"suppressAttachments"))?"":j();};m.readFormatters.msg_has_attachment=function(){var n=m.message;return m.isSandboxActive()&&(!G.Lang.isUndefined(n.body)&&m.hasOMFlag(n,"suppressAttachments"))?"":l();};Y=m.readFormatters.msg_blocked;m.readFormatters.msg_blocked=function(){var n=m.message,o=NeoConfig.isFresh?"_shared_module_message_display_fresh_rollup":"_shared_module_message_display_rollup";return(m.isSandboxActive()&&n.extend&&n.extend.openmail&&n.extend.openmail.imgBlocked)?k({s:N[o].msg_blocked,o:n}):Y();};}};S.prototype.isPreviewPane=function(){return !this.fullView;};S.prototype.getTotalRetryCount=function(){return c;};S.prototype.createSandbox=function(){var j=this,Y=a.getSandboxData();if(!Y){Z("Sandbox app not found.  Switching to message pane.");return;}j.launchStatus="CREATE";O.Views.runActions(Y,"events","message_render",false,null,null,null,null,null,function(k){j.viewObj=k;j.initSandboxIframe();});};S.prototype.sendSandboxControllerEvent=function(j,Y){if(!this.viewObj){return;}G.fire(Q(this.viewObj.get("instanceId"),"sandbox.controller"),{cmd:j,args:Y});};S.prototype.render=function(Y){var j=this;j.firstActive&&j.firstActive.detach();j.firstActive=null;Y=Y||j.parentNode;if(j.firstRender&&!(Y&&Y.inDoc())){j.firstActive=j.once("activeChange",function(k){if(k.newVal){j.firstRender=0;S.superclass.render.apply(j,[Y]);j.firstActive=null;}});}else{S.superclass.render.apply(j,[Y]);}};S.prototype.scrollWidthReset=function(){var Y=this;S.superclass.scrollWidthReset.apply(Y);if(Y.isSandboxActive()){Y.sendSandboxControllerEvent("resetwidth",{"viewId":Y.viewObj.get("viewId")});}};S.prototype.initSandboxIframe=function(){var m=this,j;if(!m.viewObj){Z("viewObj is not available.  Use default appendMarkup.");S.superclass.appendMarkup.apply(m);return;}if(m.launchStatus=="CREATE"){m.startStopwatch(1,"LoadSandbox");m.sandboxStartTime=new Date();m.RSstopwatch=new d.Stopwatch("LoadSandbox");Z("Waiting for sandbox to register.");j=m.message;if(j){m.message={flags:j.flags,header:j.header,mid:j.mid};
}S.superclass.appendMarkup.apply(m);m.message=j;var Y=m.get("parentNode"),l=Y.one(".tripane.content")||Y.one(".message.content"),k=setTimeout(function(){if(m.launchStatus!="TIMEOUT"){Z("TIMEOUT: sandbox failed to register!");m.launchStatus="TIMEOUT";m.closeSandbox();if(++c===U){G.mail.Controller.Messages.unhook("get",K);}}S.superclass.appendMarkup.apply(m);I.stat("OM","ERR:registerSandbox");},B);l.append(m.viewObj.getMarkup());m.viewObj.initIframe();m.launchStatus="WAIT";m.applyHandler();m.once("sandboxViewReady",function(){m.RSstopwatch&&m.RSstopwatch.stop&&m.RSstopwatch.stop();if(m.sandboxStartTime){window.rt_LogTime&&rt_LogTime("t2",(new Date())-m.sandboxStartTime,true);m.sandboxStartTime=null;}Z("SUCCESS: registered!");m.launchStatus="REGISTERED";clearTimeout(k);m.isSandboxViewReady=true;});m.viewObj.once("load",function(){m.sendSandboxControllerEvent("initsandboxview",{viewId:m.viewObj.get("viewId"),data:{fullView:m.fullView}});});}};S.prototype.appendMarkup=function(){var Y=this;if(!f||!g){Z("Default appendMarkup");S.superclass.appendMarkup.apply(Y);return;}if(Y.launchStatus=="INIT"||Y.launchStatus=="TIMEOUT"){if(c<U){Y.createSandbox();}}Y.handleSandbox();};S.prototype.applyHandler=function(){var j=this,Y=j.viewObj.get("viewId");j.internalAPIHandler=G.on("om:msg:"+Y,j.handleInternalAPI,j);j.on("activeChange",function(k){j.sendSandboxControllerEvent("activechange",{viewId:Y,newVal:k.newVal});if(k.newVal===1&&NeoConfig.fullPage){j.sendSandboxControllerEvent("updateheight",{"viewId":Y});}});j.on("closeChange",function(k){if(k.newVal===1){j.closeSandbox();}});};S.prototype.closeSandbox=function(){var j=this,Y=(j.viewObj)?j.viewObj.get("viewId"):null;j.isSandboxViewReady=false;j.firstMsgDisplayed=false;j.sandboxStartTime=null;j.RSstopwatch=null;if(Y){j.sendSandboxControllerEvent("closesandboxview",{"viewId":Y});if(j.heightUpdateTimer){j.heightUpdateTimer.cancel();}O.Views.closeView(Y);j.viewObj=null;}if(j.internalAPIHandler){j.internalAPIHandler.detach();j.internalAPIHandler=null;}if(j.handleContactChanged){j.handleContactChanged.detach();j.handleContactChanged=null;}if(j.msgRenderTimer){clearTimeout(j.msgRenderTimer);j.msgRenderTimer=null;}};S.prototype.handleSandbox=function(){try{var p=this,j=p.viewObj,n=p.message,o=!!(n&&!n.body&&!p.loading_slow&&!p.loading_error)||p.outboundReq,Y=p.formatters.page_show_comm_modes()+p.formatters.page_show_comm_modes_else(),l=(n&&n.body)?p.getEnhancedBody()||n.body.display:"";}catch(m){I.stat("OM","ERR:genMarkup");}function k(){try{p.RSstopwatch=new d.Stopwatch("DisplayMessageInSandbox");p.startStopwatch(1,"DisplayMessageInSandbox");p.msgReadRtbApps=n&&n.extend&&n.extend.openmail&&n.extend.openmail.context.msgReadRtbApps;var q=null,w={data:{}},y=n&&n.extend&&n.extend.openmail&&n.extend.openmail.context,t=n&&n.extend&&n.extend.openmail&&n.extend.openmail.onreadScripts||[],x=G.Array.map(y&&G.Object.keys(n.extend.openmail.context.matchedAppIds)||[],function(z){return z.split(".")[0];});if(y){w.data=O.Messageread.repackageData(n);}w.data.loading=o;w.data.matchedAppIdList=x;w.data.appCodes=[];w.data.body={content:Y,msgBody:l,truncated:(n&&n.body&&n.isTruncated),scrollTop:p.scrollTop,href:p.href,isChat:p.isChat(n)};if(n&&n.body){var v=NeoConfig.isFresh?"_shared_module_message_display_fresh_rollup":"_shared_module_message_display_rollup";w.data.body.msgBlockedMarkup=b(N[v].msg_blocked,n,p.readFormatters,0,strings);}for(var s=0,r=t.length;s<r;++s){q=t[s];w.data.appCodes.push({css:q.css,scripts:q.scripts,APIContext:q.context});}Z("Send mesage to Sandbox.");if(n&&n.body){if(p.msgRenderTimer){clearTimeout(p.msgRenderTimer);}p.msgRenderTimer=setTimeout(function(){p.launchStatus="TIMEOUT";p.closeSandbox();S.superclass.appendMarkup.apply(p);I.stat("OM","ERR:sendMessageToSandbox");},h);}p.sendSandboxControllerEvent("render",{viewId:p.viewObj.get("viewId"),data:w});}catch(u){I.stat("OM","ERR:fireRenderEvent");}}if(p.isSandboxViewReady){k();}else{p.once("sandboxViewReady",function(){k();});}};S.prototype.handleSandboxRenderComplete=function(){var m=this,j=m.viewObj?m.viewObj.get("viewId"):null,l=m.viewObj?m.viewObj.getIframe():null,k=function(){var n;S.superclass.renderComplete.apply(m);if(l){if(m.message&&m.message.header){n=m.message.header.subject;}l.set("title",n||strings["str_comp_nosubject"]);}};if(m.msgRenderTimer){clearTimeout(m.msgRenderTimer);m.msgRenderTimer=null;}if(!m.firstMsgDisplayed){m.firstMsgDisplayed=true;var Y=m.get("parentNode");if(Y){Y.all(".message.content > div").remove();}if(l){l.addClass("enabled");}if(NeoConfig.fullPage){m.heightUpdateTimer=G.later(R,m,function(){if(m.get("active")){m.sendSandboxControllerEvent("updateheight",{"viewId":j});}},null,true);}}else{window.rt_LogTime&&rt_LogTime("t2",0,true);}if(!m.outboundReq&&m.message&&m.message.body){G.UA.ie?setTimeout(k,0):k();}};S.prototype.renderProfileImage=function(j){var l=this,Y=l.viewObj?l.viewObj.get("viewId"):null,k;if(G.Lang.isArray(j)&&j.length==1){j=j[0];}if(!l.isSandboxActive()){S.superclass.renderProfileImage.apply(l,[j]);return;}k=S.superclass.getProfileImageMarkup.apply(l,[j]);if(k){l.sendSandboxControllerEvent("updateheaderprofileimage",{"viewId":Y,data:{html:k}});}};S.prototype.renderComplete=function(Y){var j=this;if(!j.isSandboxActive()){S.superclass.renderComplete.apply(j);return;}j.RSstopwatch&&j.RSstopwatch.stop&&j.RSstopwatch.stop();};S.prototype.postRender=function(){var Y=this;if(Y.isSandboxActive()){Y.sendSandboxControllerEvent("resizeSubject",{viewId:Y.viewObj.get("viewId")});}S.superclass.postRender.apply(Y);};S.prototype.handleSandboxDOMSubtreeModified=function(Y){var j=this;i.getIFrameById(j.viewObj.get("viewId")).setStyle("height",Y.height+"px");};S.prototype.handleSandboxDOMSubtreeModifiedWidth=function(Y){var j=this;S.superclass.scrollWidthUpdate.apply(j,arguments);};S.prototype.handleAttachmentDownloadSingle=function(Y){var j=this;j.downloadAttachment(Y.partId,Y.tnefId);};S.prototype.handleAttachmentDownloadAll=function(Y){this.downloadAllAttachments("non-image");
};S.prototype.handleAttachmentDownloadAllPhotos=function(Y){this.downloadAllAttachments("image");};S.prototype.handleAttachmentDownloadEverything=function(Y){this.downloadAllAttachments("all");};S.prototype.handleMessageSetFlag=function(Y){var j=this;G.use("mail-ui-messageevents",function(l){var k=j.message.flags.isFlagged?"unflagged":"flagged";l.mail.ui.MessageEvents.handleUI({action:k},j.fid,null,[j.message]);});};S.prototype.handleMessageSetUnread=function(Y){var j=this;G.use("mail-ui-messageevents",function(l){var k=j.message.flags.isRead?"unread":"read";l.mail.ui.MessageEvents.handleUI({action:k},j.fid,null,[j.message]);});};S.prototype.handleMailTo=function(Y){G.use("mail-ui-shortcuts",function(j){j.mail.ui.ShortCuts.composeMailToMessage(Y.mailto);});};S.prototype.handleMRD=function(Y){G.use("mail-controller-mrd",function(j){j.fire("mrd:launch",Y.mrdLink);});};S.prototype.handleUnblockImages=function(Y){var j=this;j.unblockImages();};S.prototype.handleLoadOptions=function(Y){var j=this;j.loadOptions();};S.prototype.handleRetryLoad=function(Y){var j=this;j.retryLoad();};S.prototype.handleToggleShowDetails=A("toggleShowDetails","mail-ui-messagepane-bind");S.prototype.showMore=function(Y){this.sendSandboxControllerEvent("showMore",{"viewId":this.viewObj.get("viewId"),"markup":this.getAllLozenges(Y.field),"field":Y.field});};S.prototype.updateMessageFlagMarkup=function(Y){if(!f||!this.viewObj){S.superclass.updateMessageFlagMarkup.apply(this);return;}this.sendSandboxControllerEvent("messageflagstatus",{"viewId":this.viewObj.get("viewId")});};S.prototype.updateMessageReadMarkup=function(Y){if(!f||!this.viewObj){S.superclass.updateMessageReadMarkup.apply(this);return;}this.sendSandboxControllerEvent("messagereadstatus",{"viewId":this.viewObj.get("viewId")});};S.prototype.updateLozenges=function(Y){if(!f||!this.viewObj){return;}this.sendSandboxControllerEvent("handleupdatelozenges",{viewId:this.viewObj.get("viewId"),data:{contacts:Y.details[0]}});};S.prototype.convertShortcuts=function(){};S.prototype.setFocusToSandboxElement=function(Y){if(this.viewObj){this.sendSandboxControllerEvent("setfocus",{viewId:this.viewObj.get("viewId"),selector:Y});}};S.prototype.pressLozenge=function(Y){if(this.viewObj){this.sendSandboxControllerEvent("pressLozenge",{viewId:this.viewObj.get("viewId"),selector:Y});}};S.prototype.unpressLozenge=function(Y){if(this.viewObj){this.sendSandboxControllerEvent("unpressLozenge",{viewId:this.viewObj.get("viewId"),selector:Y});}};S.prototype.startStopwatch=function(k,j){var Y=d.Stopwatch.get("MsgInPreview")||this.stopwatch;Y&&Y.start(k,j);};S.prototype.handleInternalAPI=function(j,Y){var k=this;switch(j){case"sandboxStartStopwatch":k.startStopwatch(Y.lv,Y.msg);break;case"sandboxSetFocus":k.setFocusToSandboxElement(Y.selector);break;case"sandboxRenderComplete":k.handleSandboxRenderComplete();break;case"sandboxDOMSubtreeModified":k.handleSandboxDOMSubtreeModified(Y);break;case"sandboxDOMSubtreeModifiedWidth":k.handleSandboxDOMSubtreeModifiedWidth(Y);break;case"sandboxViewReady":k.fire("sandboxViewReady");break;case"downloadSingle":k.handleAttachmentDownloadSingle(Y);break;case"downloadAll":k.handleAttachmentDownloadAll(Y);break;case"downloadAllPhotos":k.handleAttachmentDownloadAllPhotos(Y);break;case"downloadEverything":k.handleAttachmentDownloadEverything(Y);break;case"setFlag":k.handleMessageSetFlag(Y);break;case"setUnread":k.handleMessageSetUnread(Y);break;case"mailto":k.handleMailTo(Y);break;case"mrd":k.handleMRD(Y);break;case"viewFullMsg":k.viewFullMsg(Y);break;case"unblockImages":k.handleUnblockImages(Y);break;case"loadOptions":k.handleLoadOptions(Y);break;case"retryLoad":k.handleRetryLoad(Y);break;case"toggleShowDetails":k.handleToggleShowDetails(Y);break;case"showMore":k.showMore(Y);break;case"message.readAppTime":k.handleMsgReadAppTime(Y);break;case"pressLozenge":k.pressLozenge(Y.selector);break;case"unpressLozenge":k.unpressLozenge(Y.selector);break;}};S.prototype.setDocRole=function(){};S.prototype.setRootNodeTabIndex=function(){this.get("rootNode").set("tabIndex",-1);};S.prototype.setFocusNode=function(){};S.prototype.onFocus=function(){var j=this,Y=j.fullPageView?j.getSubjectFocusNodeSelector():".message.content";if(j.launchStatus=="REGISTERED"&&j.get("active")&&j.message){j.setFocusToSandboxElement(Y);}return 1;};S.prototype.handleMsgReadAppTime=function(l){var o=this,n=o.message,k=n.mid,m=l.time,Y=a.getAppName(l.appId)||"",j=d.Stopwatch.get("MsgInPreview")||o.stopwatch;j&&j.addComment("-AppRender."+Y+":"+m);if(--o.msgReadRtbApps===0){o.fire("msgReadAppComplete");}Z("message.read app time(mid:"+k+" / appName:"+Y+"): "+m);};G.namespace("om.ui");G.om.ui.OMMessagePane=S;if(f){var X={success:function(Y,k,j){O.Messageread.postHookMessageGet(Y,k,j);}};K=G.mail.Controller.Messages.hook("get",X);}},"1.0.0",{requires:["mail-ui-messagepane-base","mail-controller-messages","json-stringify","om-model-datastore","om-controller-messageread","om-controller-views","common-utils-stats","rocket-stats"]});YUI.add("om-ui-workspace-base",function(A){A.namespace("om.ui");A.om.ui.Workspace=new function(){var G=this,D=A.om.model.DataStore.Registry,E=A.om.ui.ApplicationList;function C(H){var J=H.appId,I=H.hiliteAppId,K=H.param;B(J,I,K);}function B(I,H,J){A.use("om-controller-views",function(M){var K,L={};K=I?D.get(I):D.getGalleryData();if(!K){K={app:I};}if(H){L=[H];}else{if(J){L.launchParams=J;}}M.om.Controller.Views.runActions(K,"events","click",true,L);});}function F(){A.on("om:appclicklaunch",B);A.on("om:mrd:gallery",C);A.on("om:mrd:launch",C);}A.augment(G,A.EventTarget);A.augment(G,A.Attribute);F();if(NeoConfig.om.isSandboxEnabled&&A.UA.ie!=7){if(NeoConfig.hasConv){A.use("om-ui-convpane-base",function(H){H.mail.ui.Factory.register("mail.ui.ConvPane",H.om.ui.OMConvPane);});}else{A.use("om-ui-messagepane-base",function(H){H.mail.ui.Factory.register("mail.ui.MessagePane",H.om.ui.OMMessagePane);});}}}();},"1.0.0",{requires:["mail-ui-factory-base","om-model-datastore","om-ui-applicationlist-base","om-ui-messagepane-base"]});