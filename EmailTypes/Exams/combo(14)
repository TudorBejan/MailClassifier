YUI.add("minty_module_list_view_ad_search",function(A){A.namespace("ui.Templates");A.ui.Templates.minty_module_list_view_ad_search={base:'<div id="searchAd">{{dmcontent}}</div>',dmfavicon:'<img class="favicon" src="{{ad_favicon_url}}">',dmcontent:'<div id="searchAdFrame"><a href="{{ad_url}}" target="_blank"><span class="title">{{ad_title}}</span><span class="description">{{ad_description}}</span>{{dmfavicon}}<span class="link">{{ad_pretty_url}}</span></a></div><div id="searchAdNote">{{ad_note}}</div>'};},"1.0.0");YUI.add("mail-ui-dmsearch-view",function(D){var B=D.common.Utils,A=[];var C=function(E){var G=this,F={rootNode:{writeOnce:true},response:{},template:{value:D.ui.Templates.minty_module_list_view_ad_search}};D.augment(G,D.Attribute);G.addAttrs(F,E||{});};C.prototype={formatters:{dmfavicon:function(E,F,G){var H=G;if(!E.ad_favicon_url||E.ad_favicon_url==""){return"";}return B.substitute(H.get("template").dmfavicon,E,H.formatters,E,strings,null,H);},dmcontent:function(E,F,G){var H=G;return B.substitute(H.get("template").dmcontent,E,H.formatters,E,strings,null,H);}},render:function(){var J=this,G=J.get("rootNode"),E=G.one("#searchAd"),F=G.one("div.list-header-wrapper"),H=G.one("div.list-view-items"),I=D.Node.create(B.substitute(J.get("template").base,J.get("response"),J.formatters,J.get("response"),strings,J.get("template"),J));E&&E.remove(true);if(F){F.setStyle("top","85px");H.setStyle("top",NeoConfig.isFresh?"114px":"109px");}G.insertBefore(I,G.get("firstChild"));}};D.namespace("mail.ui");D.mail.ui.dmsearchView=C;},"1.0.0",{requires:["node-base","node-event-delegate","attribute-base","event-base","minty_module_list_view_ad_search"]});YUI.add("mail-ui-dmsearch-model",function(F){var D=F.common.Utils,A=D.escapeHtml,B=D.unescapeHtml,C=F.common.net.SessionMgr;var E=function(G){var I=this,H={seedTerm:{},response:{setter:function(J){I.response=J;}}};F.augment(I,F.Attribute);I.addAttrs(H,G||{});F.augment(I,F.EventTarget);};F.mix(E.prototype,{req:null,prepareResponse:function(I){var J,L,H,G,N,K,O=true,M=/(<([bui(strong)]|[^>]|[\/bui(strong)]*)>)/gi;if(I.Results&&I.Results.ResultSet&&I.Results.ResultSet[0]&&I.Results.ResultSet[0].Listing&&I.Results.ResultSet[0].Listing[0]){J=I.Results.ResultSet[0].Listing[0].ClickUrl.v_data;L=B(I.Results.ResultSet[0].Listing[0].a_title);H=B(I.Results.ResultSet[0].Listing[0].a_description);G=I.Results.ResultSet[0].Listing[0].a_siteHost;ad_favicon_url=I.Results.ResultSet[0].Listing[0].a_faviconUrl;O=L.match(/<.*>/)||H.match(/<.*>/);if(O){N=L.replace(M,"");K=H.replace(M,"");O=N.match(/<.*>/)||K.match(/<.*>/);}O&&D.rocketstats.stat("dmsearch","failure:badtags");if(!O){D.rocketstats.stat("dmsearch","success:displayed");return{ad_url:J,ad_title:L,ad_description:H,ad_pretty_url:G,ad_note:strings.str_dm_note,ad_favicon_url:ad_favicon_url};}}D.rocketstats.stat("dmsearch","failure:noads");},cleanSeedTerm:function(H){var G=/^(subject)\:"|^(subject)\:|("$)/gi;return H.replace(G,"");},execute:function(G,H){var L=this,I,J=[];handler=function(M,O){var P={},N=(O)?O.status:"";switch(N){case 200:try{P=F.JSON.parse(O.responseText);break;}catch(Q){}default:D.rocketstats.stat("dmsearch","failure:netfailure");}P=L.prepareResponse(P);G&&G.call(H,P);};if(!L.get("seedTerm")){return;}if(L.get("seedTerm")){var K=L.get("seedTerm");if(K.match(/subject:.*/)){K=B(A(K));}L.set("seedTerm",K.replace(/([\#|\%|\&])/g," "));}I="/dm"+NeoConfig.dmFeedname+"?";J.push("partner="+strings.str_cfg_tog_dm_source_tag);J.push("url="+document.location.host);J.push("serveUrl="+document.location.host);J.push("affilData="+encodeURIComponent("ip="+NeoConfig.ipAddress+"&ua="+navigator.userAgent+"&ur="));J.push("maxListings="+NeoConfig.dmMaxListings);J.push("cookie="+encodeURIComponent(F.Cookie.get("B")));J.push("seedTerm="+L.cleanSeedTerm(L.get("seedTerm")));if(!NeoConfig.isFullSSL){J.push("enableFavicon=1");}I=I+J.join("&");L.req=C.requestProxy(I,{on:{success:handler,failure:handler},method:"GET",service:"dmsearch",timeout:5000});}},true);F.namespace("mail.ui");F.mail.ui.dmsearchRequest=E;},"1.0.0",{requires:["common-net-sessionmgr"]});YUI.add("mail-ui-dmsearch-controller",function(C){var A=C.common.Utils;var B=function(D){var F=this,E={rootNode:{},seedTerm:{},response:{setter:function(G){F.response=G;}},responseTime:{value:0}};C.augment(F,C.Attribute);F.addAttrs(E,D||{});C.augment(F,C.EventTarget);};B.prototype={dmsearchRequest:null,process:function(){var F=this,E=(new Date()).getTime(),D=function(G){F.set("responseTime",(new Date()).getTime()-E);if(G){F.set("response",G);}else{if(F.get("rootNode")){A.rocketstats.stat("dmsearch","staticad");F.set("response",F.getStaticAd());}}A.rocketstats.stat("dmsearch","responsetime",F.get("responseTime"));};F.dmsearchRequest=new C.mail.ui.dmsearchRequest({seedTerm:F.get("seedTerm")});F.dmsearchRequest.execute(D,F);},getStaticAd:function(){var D=window.strings;return{ad_url:A.substitute(D.str_cfg_url_dm_static_content_mail_search_tip,D),ad_title:D.str_dm_title,ad_description:D.str_dm_description,ad_pretty_url:D.str_dm_pretty_url,ad_note:""};},render:function(){var E=this,D=new C.mail.ui.dmsearchView({rootNode:E.get("rootNode"),response:E.get("response")||{}});if(E.get("responseTime")&&!E.get("response")){return;}E.get("rootNode")&&D.render();if(!E.get("response")){E.after("responseChange",function(){E.render();});}}};C.namespace("mail.ui");C.mail.ui.dmsearchController=B;},"1.0.0",{requires:["event-base","mail-ui-dmsearch-view","mail-ui-dmsearch-model"]});