YUI.add("mail-ui-messagepane-bind",function(B){B.namespace("mail.ui");var J=B.mail.ui._MessagePane,L=J.prototype,C=B.common.Utils,O=B.mail.persist.MetaData,Q=B.mail,F=Q.ui.MessagePaneUtils,N=".message-header";var R=function(V){var T=C.getDataAction(V).action,U=V.target,W,S;if(T&&(T=="contact-card-menu"||T=="modal")){if(U.hasClass("lozenge")){W=U;}else{S=U.get("parentNode");if(S.hasClass("lozenge")){W=S;}}if(W){I.call(this,W);}V.halt();}},D=function(Z){var Y=this,T=Z.currentTarget,W=C.getDataAction(Z),X=W.action,d,U,c=Y.getRoot(),V,a;if(X){switch(X){case"search":P.call(Y,T);Z.halt();a={action:"subject",spid:"search_results"};break;case"msg-attachments":Z.halt();Y.downloadAllAttachments("all",Z);a={action:"download_paperclip"};break;case"more":Z.preventDefault();E.call(Y,T,W);dataId=W.node&&W.node.getAttribute("data-id");a={"action":"lozenge_more","append":{ltxt:dataId}};break;case"msg-flag":d=Y.message.flags.isFlagged?"unflagged":"flagged";B.use("mail-ui-messageevents",function(){Q.ui.MessageEvents.handleUI({action:d},Y.fid,Y.msgList,[Y.message]);});a={"action":"flag","append":{ltxt:d=="flagged"?"flag":"unflag"}};break;case"unread":d=Y.message.flags.isRead?"unread":"read";B.use("mail-ui-messageevents",function(){Q.ui.MessageEvents.handleUI({action:d},Y.fid,Y.msgList,[Y.message]);});a={"action":"read_toggle","append":{ltxt:d}};break;case"contact-card-menu":if(NeoConfig.isFresh){var S,b;Y.contextClick(Z);S=T.ancestor("ul").get("id");if(S.indexOf("msg-header-")>-1){b=S.replace("msg-header-","");}else{b="from";}a={action:"lozenge_menu",append:{ltxt:b}};}else{K.call(Y,T);}break;case"modal":Z.halt();Y.newContactClick(T);S=T.ancestor("ul").get("id");if(S.indexOf("msg-header-")>-1){b=S.replace("msg-header-","");}else{b="from";}a={"action":"lozenge_add","append":{ltxt:b}};break;case"msg-attachments":break;case"attach-download":Z.preventDefault();Y.singleDownloadClick(T);a={action:"download_single"};break;case"attach-download-all":Z.preventDefault();Y.downloadAllAttachments("non-image",Z);a={action:"download_all",append:{ltxt:"other"}};break;case"attach-download-all-photos":Z.preventDefault();Y.downloadAllAttachments("image",Z);a={action:"download_all",append:{ltxt:"photos"}};break;case"view-full-msg":Y.viewFullMsg();break;case"mail-options":Z.preventDefault();Y.loadOptions();break;case"show-images":Z.preventDefault();Y.unblockImages();break;case"toggle-msg-header":Z.halt();G.call(Y,T);break;}a&&B.fire("mt:click",a);}},A=function(Y){var X=this,Z=Y.currentTarget,T,a,U=C.getDataAction(Y),S=Z.getAttribute("href");if(U.action=="retry-msg-load"){X.retryLoad();}else{if(Z.hasClass("switchFolder")){T=Z?Z.getAttribute("sourcefolder"):0,a=Z?Z.get("innerHTML"):0;if(T){Q.FoldersView.set("fid",{fid:T,name:a});}}else{if(X.message.isTruncated&&(/^\#/.test(S))){X.viewFullMsg({cbk:function(){document.location.href=S;}});}else{var W=Z.get("parentNode");var b=null;if(Z.hasAttribute("ymailto")){b=Z.getAttribute("ymailto");}else{if(W.hasAttribute("ymailto")){b=W.getAttribute("ymailto");}}if(b&&b.length>0){Y.preventDefault();B.use("mail-ui-shortcuts",function(c){c.mail.ui.ShortCuts.composeMailToMessage(b);});}var V=null;if(Z.hasAttribute("ymrd")){V=Z.getAttribute("ymrd");}else{if(W.hasAttribute("ymrd")){V=W.getAttribute("ymrd");}}if(V){Y.preventDefault();B.use("mail-controller-mrd",function(c){c.fire("mrd:launch",V);});}}}}},H=function(U){if(strings.str_cfg_tog_ybox_enabled&&(e.target.ancestor("span.ybox-confirm",true,"li"))){return;}var V=this,T=U?U.get("id"):0,S=U?U.getAttribute("tnefid"):"";V.downloadAttachment(T,S);},M=function(S){var T=this;T.message.clickedAddress=S.getAttribute("data-address");T.message.clickedName=S.getAttribute("data-name");B.use("mail-ui-messageevents",function(){Q.ui.MessageEvents.handleUI({action:"addcontact"},T.fid,T.msgList,[T.message]);});},G=function(Z){var X=this,d,i,Y,j,h,f,V,S,c=X.getRoot(),b,T,a,U,W,g=c.one(N);X.toggleShowDetails();if(Z.hasClass("message-header")){V=Z;}else{V=Z?Z.ancestor(".message-header.y-module"):Z;}d=g.one("#msg_details");if(NeoConfig.isFresh&&V){a=V.one("h3");T=V.one(".subanchor");b=V.one(".fromto");W=parseInt(a.getComputedStyle("width"));U=parseInt(T.getComputedStyle("width"));if(V){S=V.one("#msg_details");if(S.hasAttribute("expanded-height")){if(V.hasClass("collapsed-header")){S.setStyle("height",S.getAttribute("expanded-height")+"px");}else{S.setStyle("height","0px");}}V.toggleClass("collapsed-header");}}else{j=g.one(".date span");i=g.one(".ccto");Y=g.one(".flag");f=g.one("h3");h=f.one("a");if(d){d.toggleClass("expanded");d.toggleClass("hidden");}if(j){j.toggleClass("hidden");}if(i){i.toggleClass("hidden");}if(Y){Y.toggleClass("hidden");}if(h){h.toggleClass("subanchor");}if(f){f.toggleClass("details");}Z.setContent(X.showDetails?strings["str_hide_details"]:strings["str_show_details"]);}if(NeoConfig.msg_header_images&&X.showDetails&&d.one(".update img")){d.addClass("mentos-enabled");}Z.setAttribute("title",X.showDetails?strings["str_hide_details_tooltip"]:strings["str_show_details_tooltip"]);F.resizeSubject(c);},P=function(U){var T="",S;if(U){T=B.Lang.trim(U.get("innerHTML"));}if(T.indexOf("&nbsp;")>0){T=T.replace("&nbsp;","");}T=T.replace(/\s{1,}:/g,":");S=new RegExp("^(\\b("+strings["str_comp_reply_spRE"]+"|"+strings["str_comp_reply_spFWD"]+")(\\s*)?)*","i");B.fire("search:input",{query:'subject:"'+T.replace(S,"")+'"'});},E=function(X,U){var W=this,Y,a,S,T,V,Z;Y=X?X.ancestor("ul"):0;a=X.ancestor(".details");S=X.ancestor("#msg_details");T=U.node;V=T&&T.getAttribute("data-id");if(Y){Y.setContent(W.getAllLozenges(V));}if(NeoConfig.isFresh&&X){if(a&&S){Z=parseInt(a.getComputedStyle("height"))+15;S.setStyle("height",Z+"px");S.setAttribute("expanded-height",Z);}}},I=function(S){B.use("contacts-ui-contact-popup",function(){var X=S.getAttribute("data-name"),V=S.getAttribute("data-address")||X,W=S.ancestor(".lozengeContainer"),U=!(W.one(".lozengeadd")),Y=Q.ContactPopup.TYPE_INTERMEDIATE,T=S.get("parentNode");Q.ContactPopup.showContactMenu(Y,T,{email:V,name:X,editable:false,inAB:U,copyable:true,stateChangeCB:function(Z){if(Z.state=="show"){T.addClass(NeoConfig.isFresh?"pressed":"lozenge-open-menu");
}else{T.removeClass("lozenge-open-menu").removeClass("pressed");S&&S.focus();}}});});},K=function(T){var S=T.ancestor(".lozengeContainer"),U=this;if(!S.hasClass("pressed")){highlightIt=true;}else{S.removeClass("pressed");}if(highlightIt){T.blurEvt=S.one(".lozenge.left a").on("blur",function(){T.tmFocus=B.Lang.later(100,U,function(){S.removeClass("pressed");T.blurEvt.detach();T.focusEvt.detach();});});T.focusEvt=S.one(".lozenge.left a").on("focus",function(){T.tmFocus&&T.tmFocus.cancel();});S.addClass("pressed");}};L.contextClick=R;L.retryClick=A;L.singleDownloadClick=H;L.newContactClick=M;L.handleClick=D;L.toggleShowDetails=function(){var S=this;S.showDetails=!S.showDetails;O.set("neo.pref.showHeaderDetails",S.showDetails);B.fire("mt:click",{"action":"details","append":{ltxt:S.showDetails?"show":"hide"}});};},"1.0.0");