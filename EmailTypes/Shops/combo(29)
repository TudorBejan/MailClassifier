YUI.add("mail-ui-messagepane-error",function(C){C.namespace("mail.ui");var H=C.mail.ui._MessagePane,L=C.common.Utils,I=L.rocketstats,J=L.substitute,G=NeoConfig.isFresh?C.ui.Templates._shared_module_message_display_fresh_rollup:C.ui.Templates._shared_module_message_display_rollup,D=C.mail.ui.MessagePaneUtils;function K(){var O=this.message,N="";N=(O&&O.header&&O.header.subject)?O.header.subject:strings["str_msg-view_no_subject"];return J(G.multi_retry_else,{msg_subject:L.escapeHtml(N)},0,0,strings);}function F(){var S=this,R=S.message||{},N=S.sourceFolderInfo||0,O,P,Q="";if(R.mid){O=N?N.fid:"";P=N?N.name:"";if(O){Q=J(G.diff_folder_error,{newFid:O,foldername:P},0,0,strings);}}if(!Q){Q=S.getFailureMarkup();}return Q;}function B(){return J(G.loading_slow,0,0,0,strings);}function A(){var N=this;if(N.outboundReq){N.augmentFormatters();N.slowLoad=N.loading_error=N.loading_moved=0;N.loading_slow=1;N.render();}}function E(d,V){try{var X=this,g=C.mail,W=g.model.DataStore,f,R,Z=X.retryPrefix(),a=d.reason,U=d.data&&d.data.status,Q=V?"preloadFailure":"loadMessageFailure",P=L.Stopwatch,T=P.get("MsgInPreview"),b,S,N=L.parseQueryString(),Y={"MessageFetchFailed":true,"MessageIdsNotFound":true,"MessageNotFound":true,"GetMessageInvalidId":true,"MessageSelectionNotFound":true};function O(h){var e=h&&(h.match(/Client\.([\w\W]+)$/)||h.match(/Server\.([\w\W]+)$/));return(e&&e[1])||h;}X.canRetry=true;clearTimeout(X.slowLoad);I.stat("messageread",(Z+Q));I.stat("messageread",(Z+Q+"Sbox"+((NeoConfig.om&&NeoConfig.om.isSandboxEnabled)?"On":"Off")));I.stat("messageread",(Z+Q+"Reason:"+a));S=O(d.code);b=W.Folders.get(X.fid);try{R=d?d.data:0;if(R&&!R.mid){R=R.callback.args.primeMsg;}f=R?R.mid:0;}catch(c){f="";}if(Y[S]==true||(X.numRetries>=X.maxRetries&&a==6)){X.canRetry=false;I.stat("messageread","TAE4:GDM:NoRetry:"+S);}if((Y[S]==true||a==6)){I.stat("messageread","TAE4:GDM:FAILURE:"+X.numRetries+":"+a);I.stat("messageread","TAE4:GDM:FAILURE:"+X.numRetries+":"+(b.isSystem?"system":"custom"));I.stat("messageread","TAE4:GDM:FAILURE:"+X.numRetries+":"+a+":code:"+S);I.stat("messageread","TAE4:GDM:FAILURE:"+X.numRetries+":"+a+":status:"+U);if(W.Messages.isSearchMid(f,X.fid)){I.stat("messageread","TAE4:GDM:FAILURE:SEARCHMID:"+a);I.stat("messageread","TAE4:GDM:FAILURE:SEARCHMID:"+S);}}if(X.numRetries>=X.maxRetries){if(a>0&&a<6){I.stat("messageread","tae44");}else{if(a==6){I.stat("messageread","tae45");}}}if(T){D.cleanUpStopwatch(T);T.stop("MsgInPreviewFailure");}T=X.stopwatch;if(T){T.stop("MsgInTabFailure");}X.augmentFormatters();if(N.action==="showLetter"&&N.umid===f&&S==="MessageIdsNotFound"){I.stat("messageread","TAE4:GDM:FAILURE:MRD_INVALID_ID");}X.outboundReq=X.request=null;clearTimeout(X.slowLoad);X.changingRequest=X.isRetrying=X.loading_slow=0;if(a==C.mail.Controller.Messages.Error.moved){X.fireEvent("moved",f);X.sourceFolderInfo=R.sourceFolderInfo?R.sourceFolderInfo:0;X.loading_moved=1;}else{if(d.code!=C.common.net.Error.abort){X.fireEvent("getFailure",f);X.loading_error=parseInt(a)||C.mail.Controller.Messages.Error.failed;}}if(X.loading_error||X.loading_moved){X.render();}}catch(c){I.stat("messageread","onFailureError");}}function M(){var O=this,N=3;O.maxRetries=N;if(!O.readFormatters.loading_slow){C.mix(O.readFormatters,{loading_slow:function(){return O.loading_slow?O.getSlowMarkup():"";},loading_error:function(){return O.loading_error?J(G.loading_error,null,O.readFormatters,0,strings):"";},is_perm:function(){return(O.numRetries>=N&&O.loading_error==6)?J(G.is_perm,{msg_fail_tae_code:45},0,0,strings):"";},is_perm_else:function(){return(O.numRetries<N||(O.loading_error!=6&&O.numRetries>=N))?J(G.is_perm_else,null,O.readFormatters,0,strings):"";},multi_retry:function(){return O.numRetries>=N?J(G.multi_retry,{msg_fail_tae_code:44},0,0,strings):"";},multi_retry_else:function(){return O.numRetries<N?O.getFailureMarkup():"";},can_retry:function(){return(O.canRetry==true)?J(G.can_retry,null,0,0,strings):"";},diff_folder_error:function(){return O.loading_moved&&(!O.numRetries||O.numRetries<N)?O.getMovedMarkup():"";}});}}C.mix(H.prototype,{getFailureMarkup:K,getMovedMarkup:F,getSlowMarkup:B,onFailure:E,handleSlowRequest:A,augmentFormatters:M});},"1.0.0",{requires:["common-utils"]});